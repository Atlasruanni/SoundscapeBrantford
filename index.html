<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brantford Soundscape Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- POST-PROCESSING SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/LuminosityShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/LuminosityHighPassShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            /* overflow-y: auto; -- Restored scrollable state */
            background-color: #000000; 
            color: #f5f5f7;
        }
        
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Canvas fixed in background */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            outline: none;
            pointer-events: auto; 
        }

        /* Overlay content */
        .content-section {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            align-items: center;
            pointer-events: none; /* Let clicks pass through to canvas by default */
        }
        
        /* Apple-esque Glass Card */
        .glass-card {
            pointer-events: auto; /* Enable interaction with cards */
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(44, 44, 46, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Typography Enhancements */
        
        .dark-text-shadow {
            /* Text shadow removed as requested */
        }

        /* Section titles */
        .section-title {
            letter-spacing: -0.03em;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); 
        }

        /* Grid Layouts */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Updated Scroll Indicator Styling */
        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.8; /* Increased visibility */
            display: flex; /* ADDED */
            flex-direction: column; /* ADDED */
            align-items: center; /* ADDED */
        }
        .scroll-indicator svg { /* ADDED */
            margin-top: 4px;
            animation: bounce 1.5s infinite;
        }
        
        /* FIX: Class to control animation state */
        .scroll-indicator.paused svg {
            animation-play-state: paused;
        }

        @keyframes pulse {
            0% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
            50% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            100% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
        }
        @keyframes bounce { /* ADDED */
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-8px);
            }
            60% {
                transform: translateY(-4px);
            }
        }

        .loader {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: #000000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        
        /* Navigation Blur */
        nav {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-link {
            position: relative;
            color: #86868b;
            transition: color 0.3s;
            font-size: 12px;
        }
        .nav-link:hover { color: #fff; }

        /* Audio Start Overlay: Full screen, must be clicked */
        #audio-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000; /* Solid black background */
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 500;
            z-index: 1000; /* High z-index to cover everything */
            opacity: 1;
            transition: opacity 0.5s;
            pointer-events: auto; /* Must be clickable */
            cursor: pointer;
        }
        #audio-start-overlay.hidden {
             opacity: 0;
             pointer-events: none;
        }


        /* Floating Message Box */
        #message-box {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            font-size: 14px;
        }
        
        /* Overlay Containers for main content blocks */
        .main-content-overlay {
            position: fixed;
            top: 50%;
            /* Left/Right positioning handled inline or below */
            transform: translate(0, -50%);
            width: 90%;
            max-width: 400px;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
        }

        /* Custom Confirmation Modal (Added) */
        #confirm-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #confirm-modal {
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(15px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 350px;
            text-align: center;
        }
        
        /* 360 Toggle Button Group Styling */
        .toggle-group {
            position: fixed;
            bottom: 6px; /* Reduced from 6 to give more space */
            right: 6px;
            z-index: 1001; /* High Z-index */
            display: flex;
            align-items: center;
            gap: 8px; /* Space between buttons */
        }
        
        /* Style adjustments for the main toggle button (360 View) */
        #btn-360-toggle {
            pointer-events: auto;
            display: flex;
            align-items: center;
        }


    </style>
</head>
<body class="text-slate-200 antialiased">

    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-r-2 border-yellow-500 mb-4"></div>
            <p class="text-[10px] font-bold tracking-[0.3em] text-zinc-500 uppercase">Loading Experience</p>
        </div>
    </div>
    
    <!-- Full screen overlay for audio start -->
    <div id="audio-start-overlay" class="flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500 mb-4 animate-pulse"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/><path d="M10 8l6 4-6 4V8z"/></svg>
        Tap Anywhere to Start Soundscape
    </div>

    <!-- Feedback Message Box -->
    <div id="message-box"></div>

    <!-- Custom Confirmation Modal (New) -->
    <div id="confirm-modal-overlay">
        <div id="confirm-modal">
            <h3 class="text-xl font-bold text-red-400 mb-3">System Restart Warning</h3>
            <p class="text-zinc-300 mb-6">Are you sure you want to restart the device? This will reload the entire application.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel" class="px-5 py-2 rounded-full bg-zinc-600 hover:bg-zinc-500 transition text-white">Cancel</button>
                <button id="confirm-restart" class="px-5 py-2 rounded-full bg-red-600 hover:bg-red-500 transition text-white font-bold">Restart Now</button>
            </div>
        </div>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 px-6 md:px-12 py-4 flex justify-between items-center pointer-events-auto">
        <div class="text-lg font-bold tracking-tighter text-white">
            BRANTFORD.<span class="text-yellow-500">SOUNDSCAPE</span>
        </div>
        <!-- Navigation links removed -->
        
        <!-- Exit 360 View Button (Top Right, fixed to Nav position) - Visibility controlled by JS -->
        <button id="btn-360-exit" class="p-2 rounded-full bg-red-600/90 backdrop-blur-md text-white hover:bg-red-500/90 transition shadow-lg opacity-0 pointer-events-none" style="position: fixed; top: 20px; right: 24px; z-index: 1000;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </nav>
    
    <!-- 360 View Toggle Group (Bottom Right) -->
    <div class="toggle-group">
        <!-- 360 Exit Button (Hidden unless 360 mode is active) -->
        <button id="btn-360-exit-bottom" class="p-3 rounded-full bg-zinc-700/70 backdrop-blur-md text-white hover:bg-zinc-600/80 transition shadow-lg opacity-0 pointer-events-none">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        
        <!-- 360 View Toggle Button (Always visible when not in 360 mode) -->
        <button id="btn-360-toggle" class="z-50 p-3 rounded-full bg-zinc-800/70 backdrop-blur-md text-white hover:bg-zinc-700/80 transition shadow-lg pointer-events-auto flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
            <span class="text-sm font-medium">360° View</span>
        </button>
    </div>
    
    <!-- FIXED OVERLAYS -->
    
    <!-- 1. Core Functions Overlay (Left-Focused) -->
    <div id="functional-card-overlay" class="main-content-overlay left-6 max-w-md w-full px-6">
        <div class="glass-card p-8 w-full">
            <h2 class="section-title text-3xl font-bold mb-6 text-white text-left">Core Functions.</h2>
            <div class="bento-grid">
                <!-- Music -->
                <div class="p-4 flex flex-col justify-between h-32 bg-zinc-700/50 rounded-2xl hover:bg-zinc-700/80 transition">
                    <div class="text-yellow-400 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-0">Music <span class="text-xs font-mono ml-1 text-yellow-300 opacity-70">⠍⠥⠎⠊⠉</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Calming soundscapes.</p>
                    </div>
                </div>

                <!-- Story -->
                <div class="p-4 flex flex-col justify-between h-32 bg-zinc-700/50 rounded-2xl hover:bg-zinc-700/80 transition">
                    <div class="text-yellow-400 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-0">Story <span class="text-xs font-mono ml-1 text-yellow-300 opacity-70">⠎⠞⠕⠗⠽</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Local history & culture.</p>
                    </div>
                </div>

                <!-- City Info -->
                <div class="p-4 flex flex-col justify-between h-32 bg-zinc-700/50 rounded-2xl hover:bg-zinc-700/80 transition">
                    <div class="text-yellow-400 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-0">City Info <span class="text-xs font-mono ml-1 text-yellow-300 opacity-70">⠉⠊⠞⠽ ⠊⠝⠋⠕</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">AI-powered updates.</p>
                    </div>
                </div>

                <!-- Record -->
                <div class="p-4 flex flex-col justify-between h-32 bg-zinc-700/50 rounded-2xl hover:bg-zinc-700/80 transition">
                    <div class="text-red-500 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" /></svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-0">Record <span class="text-xs font-mono ml-1 text-yellow-300 opacity-70">⠗⠑⠉⠕⠗⠙</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Leave feedback.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2. Universal Control Overlay (Right-Focused) -->
    <div id="universal-card-overlay" class="main-content-overlay right-6 max-w-sm w-full px-6">
        <div id="tactile-card" class="glass-card p-8 inline-block text-left w-full">
            <h2 class="section-title text-3xl font-bold mb-6 text-white text-left">Universal Control.</h2>
            <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Tactile Dial</h3>
                    <p class="text-xs text-zinc-500 uppercase tracking-widest">Interface</p>
                </div>
            </div>
            <p class="text-zinc-300 text-sm leading-relaxed">
                A single, intuitive dial controls volume and playback using globally recognized symbols.
                <span class="text-white block mt-2 font-medium">The central green light pulses to represent battery life and active device status.</span>
            </p>
            
            <!-- Universal Control Overlay (Buttons) -->
            <div id="universal-overlay" class="mt-8 transition-opacity duration-500">
                <div id="overlay-controls-container" class="glass-card p-4 pointer-events-auto w-full mx-auto" style="border-radius: 30px; border: none; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px);">
                    <!-- Horizontal Layout of Controls -->
                    <div id="overlay-controls" class="flex justify-around items-center space-x-2 text-white">
                        
                        <!-- Vol Up (Plus Icon) -->
                        <button id="btn-vol-up" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Volume Up">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        </button>

                        <!-- Last Track (Prev) -->
                        <button id="btn-prev" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Previous Track">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>
                        </button>
                        
                        <!-- Play/Pause Toggle -->
                        <button id="btn-play-pause-overlay" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Play/Pause">
                            <svg id="play-pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500"><path d="M3 22v-20l18 10-18 10z"/></svg>
                        </button>

                        <!-- Next Track -->
                        <button id="btn-next" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Next Track">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                        </button>

                        <!-- Vol Down (Minus Icon) -->
                        <button id="btn-vol-down" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Volume Down">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. Maintenance Access Overlay (Top-Focused) -->
    <div id="maintenance-access-overlay" class="main-content-overlay top-24 left-1/2 transform -translate-x-1/2 max-w-3xl w-full px-6">
        <div class="glass-card p-1 flex items-center gap-4 bg-red-900/10 border-red-500/20">
            <div class="bg-red-500/10 p-4 h-full flex items-center rounded-l-[28px]">
                <span class="text-red-500 font-bold text-xs uppercase tracking-wider rotate-180" style="writing-mode: vertical-rl;">Admin</span>
            </div>
            <div class="py-4 pr-6">
                <h3 class="text-white font-bold text-lg">Maintenance Access</h3>
                <p class="text-zinc-400 text-sm mt-1">
                    The <span class="text-red-400">Restart Button</span> is concealed on the bottom face, accessible only to City staff for secure resetting and diagnostics.
                </p>
            </div>
        </div>
    </div>


    <!-- SCROLL ANCHOR SECTIONS -->
    
    <!-- Section 1: Hero / Overview -->
    <section id="front" class="content-section justify-center text-center px-6">
        <div class="fade-in-section max-w-4xl mx-auto mt-[40vh] md:mt-[35vh]">
            <h1 class="section-title text-5xl md:text-8xl font-bold mb-6 text-white">
                Public Atmosphere.<br>Reimagined.
            </h1>
            <p class="text-zinc-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed font-light dark-text-shadow">
                An interactive audio experience designed to enhance community connection and deliver real-time information to Brantford.
            </p>
        </div>
        <div class="scroll-indicator text-zinc-500 text-xs font-medium tracking-widest uppercase">
            Scroll
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v10.586l3.293-3.293a1 1 0 111.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L9 14.586V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
        </div>
    </section>

    <!-- Section 2: Functional Keys (Anchor only) -->
    <section id="functional" class="content-section h-[120vh]"></section>

    <!-- Section 3: Universal Controls (Anchor only) -->
    <section id="universal" class="content-section h-[120vh]"></section>

    <!-- Section 4: Maintenance (Anchor only) -->
    <section id="specs" class="content-section h-[120vh] flex flex-col justify-end relative">
        <footer class="absolute bottom-6 w-full text-center text-white/50 text-xs tracking-wider uppercase">
            Designed for Brantford &copy; 2025
        </footer>
    </section>

    <!-- System Restart Button Overlay (Fixed, visible during Maintenance Section, Bottom-Focused) -->
    <div id="maintenance-overlay" class="fixed bottom-40 left-1/2 transform -translate-x-1/2 p-3 rounded-xl bg-red-900/10 border-red-500/20 transition-opacity duration-500 z-40 opacity-0 pointer-events-none">
        <button id="btn-restart-overlay" class="p-3 rounded-full bg-red-600 hover:bg-red-500 transition duration-200 text-white font-bold text-sm pointer-events-auto flex items-center gap-2" title="System Restart">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
            SYSTEM RESTART
        </button>
    </div>


    <script>
    // Utility function to display temporary messages to the user
    function showMessage(text, duration = 3000) {
        const box = document.getElementById('message-box');
        if (!box) return;
        
        box.textContent = text;
        box.style.opacity = 1;
        
        // Hide after duration
        setTimeout(() => {
            box.style.opacity = 0;
        }, duration);
    }
    
    // Global state
    let isPlaying = true; 
    let playPauseIcon = null;
    let is360Mode = false; // ADDED
    let isDragging = false; // ADDED
    let previousMousePosition = { x: 0, y: 0 }; // ADDED

    // Function to update the play/pause icon appearance
    function updatePlayPauseIcon(playing) {
        // Find icon on the 3D model
        const icon3D = document.getElementById('play-pause-icon');
        // Find icon on the control overlay
        const iconOverlay = document.querySelector('#btn-play-pause-overlay svg');

        const pathPause = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
        const pathPlay = `<path d="M3 22v-20l18 10-18 10z"/>`;
        
        if (icon3D) {
            icon3D.innerHTML = playing ? pathPause : pathPlay;
        }
        if (iconOverlay) {
            iconOverlay.innerHTML = playing ? pathPause : pathPlay;
        }
    }

    // Function to handle the actual play/pause toggle
    function toggleAudioPlayback() {
        if (isPlaying) {
            AudioManager.stopBackgroundMusic(); // Only stops background music
            isPlaying = false;
            showMessage("Audio Paused.", 2000);
        } else {
            AudioManager.play('music'); // Resumes background music
            isPlaying = true;
            showMessage("Audio Resumed.", 2000);
        }
        updatePlayPauseIcon(isPlaying);
    }

    // Function to hide the initial overlay after interaction
    function hideInitialOverlay() {
        const overlay = document.getElementById('audio-start-overlay');
        if (overlay) {
            overlay.classList.add('hidden');
        }
    }


    // AUDIO MANAGER (FIXED)
    const AudioManager = {
        trackList: [
            'jazz-background-music-333352.mp3',
            'jazz-background-music-338663.mp3',
            'jazz-background-music-379027.mp3',
            'jazz-background-music-426859.mp3'
        ],
        currentTrackIndex: 0,
        audioElement: null,
        sources: {
            recordBeep: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
        },
        current: null,
        isRecording: false,
        recorder: null,
        stream: null,
        hasInteracted: false,

        init() {
            this.audioElement = new Audio();
            this.audioElement.loop = false; // Set to false to allow 'ended' event to fire
            this.audioElement.volume = 0.5;
            this.sources.recordBeep.volume = 0.7;
            
            this.loadTrack(this.currentTrackIndex);
            
            // Auto-advance to the next track on normal end
            this.audioElement.addEventListener('ended', () => {
                if (this.current === 'music' && isPlaying) {
                    this.playNextTrack();
                }
            });
        },

        loadTrack(index) {
            this.currentTrackIndex = (index % this.trackList.length + this.trackList.length) % this.trackList.length;
            this.audioElement.src = this.trackList[this.currentTrackIndex];
            this.audioElement.load();
            if (isPlaying && this.hasInteracted) {
                 // Try to resume play if the user hasn't explicitly paused
                 this.audioElement.play().catch(e => console.log("Track resume failed after source change."));
            }
        },

        playNextTrack() {
            this.loadTrack(this.currentTrackIndex + 1);
            showMessage(`Next Track: Playing Track ${this.currentTrackIndex + 1}`, 2000);
        },

        playPrevTrack() {
            this.loadTrack(this.currentTrackIndex - 1);
            showMessage(`Previous Track: Playing Track ${this.currentTrackIndex + 1}`, 2000);
        },

        volumeUp() {
            this.audioElement.volume = Math.min(1.0, this.audioElement.volume + 0.1);
            showMessage(`Volume: ${Math.round(this.audioElement.volume * 100)}%`, 1000);
        },

        volumeDown() {
            this.audioElement.volume = Math.max(0.0, this.audioElement.volume - 0.1);
            showMessage(`Volume: ${Math.round(this.audioElement.volume * 100)}%`, 1000);
        },

        startBackground() {
            if(!this.hasInteracted) {
                this.hasInteracted = true;
                hideInitialOverlay(); // Hide the overlay on first interaction
                this.play('music');
            }
        },

        stopBackgroundMusic() {
            this.audioElement.pause();
            isPlaying = false;
            updatePlayPauseIcon(isPlaying);
        },

        stopAll() {
            // Stop all current playback (music and TTS)
            this.audioElement.pause();
            window.speechSynthesis.cancel();
            this.current = null;
            isPlaying = false;
            updatePlayPauseIcon(isPlaying);
        },

        play(type) {
            if(this.isRecording) return;
            
            // Handle background music play/resume logic
            if (type === 'music') {
                 // NEW MUSIC LOGIC: If music is already playing, do nothing
                 if (this.current === 'music' && !this.audioElement.paused) return; 
                 
                 // If TTS/Story/Info is active, stop it immediately.
                 if (this.current === 'story' || this.current === 'info') {
                     window.speechSynthesis.cancel();
                 }

                 this.audioElement.currentTime = 0; 
                 this.audioElement.play().catch(e => {
                     console.error("Audio play failed for Background Music:", e);
                     showMessage("Audio playback restricted. Please ensure you have interacted with the page.", 6000);
                 }); 
                 this.current = 'music';
                 isPlaying = true;
                 updatePlayPauseIcon(isPlaying);
                 return;
            }

            // Handle functional key audio (TTS, Story, Info). 
            // If a new function is clicked, PAUSE EVERYTHING else and play the new one.
            this.stopAll(); // Stops background music and TTS/Info/Story
            
            if (type === 'story') {
                const text = "Welcome to Brantford history. In 1874, Alexander Graham Bell invented the telephone right here. The Bell Homestead is a national historic site honoring this breakthrough.";
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; 
                window.speechSynthesis.speak(u);
                this.current = 'story';
                // Resume background music when TTS finishes
                u.onend = () => this.play('music'); 
            } else if (type === 'info') {
                const text = "Brantford City Update. Current temperature is 14 degrees Celsius. Road work on Colborne Street is expected to finish by Friday. Have a safe walk.";
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; 
                window.speechSynthesis.speak(u);
                this.current = 'info';
                // Resume background music when TTS finishes
                u.onend = () => this.play('music');
            }
        },

        async toggleRecord(onStart, onStop) {
            if (this.isRecording) {
                // STOP RECORDING
                if(this.recorder && this.recorder.state !== 'inactive') {
                    this.recorder.stop();
                }
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                this.isRecording = false;
                onStop(); // Red dot to black
                this.play('music'); // **Music continues**
                console.log("Recording stopped. Music resumed.");
            } else {
                // START RECORDING
                this.stopAll(); // **Pause all other audio (including music)**
                this.sources.recordBeep.currentTime = 0;
                this.sources.recordBeep.play(); // Play SFX before mic request

                try {
                    // Request microphone access
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(this.stream);
                    this.recorder.start();
                    this.isRecording = true;
                    onStart(); // Black dot to red
                    console.log("Recording started. Waiting for second click to stop.");
                } catch (e) {
                    // Handle mic refusal/failure gracefully
                    onStop();
                    // Display user-friendly message
                    if (e.name === "NotAllowedError" || e.name === "Permission denied") {
                        showMessage("Recording failed: Microphone access was denied by the browser.", 4000);
                    } else {
                        showMessage("Recording failed due to a device error.", 4000);
                    }
                    console.error("Microphone access denied or failed. Resuming music.", e);
                    this.play('music');
                }
            }
        }
    };

    // WRAPPED IN IIFE
    (function() {
        AudioManager.init();

        // --- SCROLL OBSERVER FOR FADE IN EFFECTS ---
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in-section').forEach(section => {
            observer.observe(section);
        });

        // --- THREE.JS SCENE CONFIGURATION ---
        const container = document.getElementById('canvas-container');
        if(container.firstChild) container.removeChild(container.firstChild);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); 

        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 10); 
        
        const renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);
        
        // --- POST-PROCESSING ---
        let composer, bloomPass;
        function initPostProcessing() {
            if (typeof THREE.EffectComposer === 'undefined') return;
            
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));

            bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5, 0.3, 0.8
            );
            composer.addPass(bloomPass);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
        initPostProcessing();

        // --- INTERACTIVITY SETUP ---
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clickableObjects = [];
        let redDotLED = null;

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.15);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(5, 5, 10);
        mainLight.castShadow = true;
        mainLight.shadow.bias = -0.0001;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        scene.add(mainLight);

        const topLight = new THREE.SpotLight(0xffffff, 3.0);
        topLight.position.set(0, 10, 0);
        topLight.lookAt(0,0,0);
        scene.add(topLight);

        const fillLight = new THREE.PointLight(0xffaa00, 0.4);
        fillLight.position.set(-5, 0, 5);
        scene.add(fillLight);

        // --- MATERIALS ---
        // Model color changed to a richer orange (0xEE8500)
        const colorYellow = 0xEE8500; 
        const matBody = new THREE.MeshPhysicalMaterial({ color: colorYellow, roughness: 0.25, metalness: 0.05, clearcoat: 0.2, clearcoatRoughness: 0.1 });
        const matBlack = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8, metalness: 0.1 });
        const colorGreen = 0x00A060; 
        const matCyan = new THREE.MeshPhysicalMaterial({ color: colorGreen, roughness: 0.3, metalness: 0.0, emissive: colorGreen, emissiveIntensity: 3.0 });
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.35, metalness: 0.9 });
        const matRedLED = new THREE.MeshStandardMaterial({ color: 0xFF0000, roughness: 0.1, metalness: 0.0, emissive: 0xFF0000, emissiveIntensity: 8.0 });
        const matBlackDot = new THREE.MeshStandardMaterial({ color: 0x010101, roughness: 0.9, metalness: 0.1, emissive: 0x000000 });
        const matGrayPress = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.8, metalness: 0.1 });

        // --- GEOMETRY HELPERS ---
        function createRoundedRect(w, h, r) {
            const shape = new THREE.Shape();
            shape.moveTo(-w/2 + r, h/2);
            shape.lineTo(w/2 - r, h/2);
            shape.quadraticCurveTo(w/2, h/2, w/2, h/2 - r);
            shape.lineTo(w/2, -h/2 + r);
            shape.quadraticCurveTo(w/2, -h/2, w/2 - r, -h/2);
            shape.lineTo(-w/2 + r, -h/2);
            shape.quadraticCurveTo(-w/2, -h/2, -w/2, -h/2 + r);
            shape.lineTo(-w/2, h/2 - r);
            shape.quadraticCurveTo(-w/2, h/2, -w/2 + r, h/2);
            return shape;
        }

        // --- BUILD DEVICE ---
        const deviceGroup = new THREE.Group();

        // Chassis
        const chassisShape = createRoundedRect(5.75, 2.2, 0.55);
        const chassisGeo = new THREE.ExtrudeGeometry(chassisShape, { depth: 0.6, bevelEnabled: true, bevelThickness: 0.08, bevelSize: 0.08, bevelSegments: 6 });
        chassisGeo.center();
        const chassis = new THREE.Mesh(chassisGeo, matBody);
        deviceGroup.add(chassis);
        const Z_SURFACE = 0.38; 

        // Left Dial (Universal Controls)
        const dialGroup = new THREE.Group();
        dialGroup.position.set(-1.75, 0, Z_SURFACE);
        
        const rimGroup = new THREE.Group();
        rimGroup.name = 'VOLUME_DIAL_RIM'; 
        rimGroup.userData.originalMat = matBlack;
        dialGroup.add(rimGroup);
        clickableObjects.push(rimGroup);

        const dishGeo = new THREE.CylinderGeometry(0.9, 1.0, 0.15, 64);
        const dish = new THREE.Mesh(dishGeo, matBlack);
        dish.rotation.x = Math.PI/2;
        dish.position.z = -0.05;
        rimGroup.add(dish);

        const slopeGeo = new THREE.CylinderGeometry(0.56, 0.9, 0.2, 64, 1, true);
        const slope = new THREE.Mesh(slopeGeo, matBlack);
        slope.rotation.x = Math.PI/2;
        slope.position.z = 0.0;
        rimGroup.add(slope);

        const btnGeo = new THREE.CylinderGeometry(0.54, 0.54, 0.1, 64);
        const btn = new THREE.Mesh(btnGeo, matCyan);
        btn.rotation.x = Math.PI/2;
        btn.position.z = 0.02;
        btn.name = 'PLAY_PAUSE_BUTTON'; 
        btn.userData.originalMat = matCyan;
        dialGroup.add(btn); 
        clickableObjects.push(btn);
        deviceGroup.add(dialGroup);

        // Center Speaker
        const cvs = document.createElement('canvas');
        cvs.width = 256; cvs.height = 512;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#000000';
        const gridY = 20; const radius = 7; const padX = 10; const padY = 10;
        const stepY = (cvs.height - padY*2) / gridY;
        const baseStepX = (cvs.width - padX*2) / 9;
        for(let y=0; y<=gridY; y++) {
            const numDots = (y % 2 === 0) ? 9 : 10; 
            const rowWidth = baseStepX * (numDots - 1);
            const centeringOffset = ((cvs.width - padX*2) - rowWidth) / 2;
            for(let x=0; x<numDots; x++) {
                ctx.beginPath();
                ctx.arc(padX + centeringOffset + x * baseStepX, padY + y*stepY, radius, 0, Math.PI*2);
                ctx.fill();
            }
        }
        const spkTex = new THREE.CanvasTexture(cvs);
        const spkPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.0, 1.8), new THREE.MeshPhysicalMaterial({ map: spkTex, color: 0x000000, roughness: 0.4, transparent: true, alphaTest: 0.1 }));
        spkPlane.position.set(-0.21, 0, Z_SURFACE + 0.01); 
        deviceGroup.add(spkPlane);

        // Right Button Cluster (Functional Keys)
        const padGroup = new THREE.Group();
        padGroup.position.set(1.55, 0, Z_SURFACE); 
        const hsShape = createRoundedRect(2.24, 1.74, 0.25);
        const hsGeo = new THREE.ExtrudeGeometry(hsShape, { depth: 0.05, bevelEnabled: false});
        hsGeo.center();
        const hs = new THREE.Mesh(hsGeo, matBlack);
        hs.position.z = 0.02;
        padGroup.add(hs);

        const btnShape = createRoundedRect(0.88, 0.66, 0.12);
        const btnGeom = new THREE.ExtrudeGeometry(btnShape, { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        btnGeom.center();
        
        const gapX = (2.24 - 2 * 0.88) / 3;
        const gapY = (1.74 - 2 * 0.66) / 3;
        const X_OFFSET = (0.88 / 2) + (gapX / 2);
        const Y_OFFSET = (0.66 / 2) + (gapY / 2);
        
        const positions = [
            { x: -X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'MUSIC_BUTTON' },
            { x: X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'STORY_BUTTON' },
            { x: -X_OFFSET, y: -Y_OFFSET, mat: matBlack, name: 'CITY_INFO_BUTTON' },
            { x: X_OFFSET, y: -Y_OFFSET, mat: matSteel, name: 'RECORD_BUTTON' }
        ];

        positions.forEach((p) => {
            const b = new THREE.Mesh(btnGeom, p.mat);
            b.position.set(p.x, p.y, 0.04);
            b.name = p.name;
            b.userData.originalMat = p.mat;
            if(p.name === 'RECORD_BUTTON') {
                const dot = new THREE.Mesh(new THREE.CircleGeometry(0.04, 16), matBlackDot);
                dot.position.set(0.88/3, -0.66/3, 0.04);
                b.add(dot);
                redDotLED = dot;
            }
            padGroup.add(b);
            clickableObjects.push(b);
        });
        deviceGroup.add(padGroup);
        
        // Restart Button (Bottom Face)
        const bottomBtnShape = createRoundedRect(1.0, 0.2, 0.08);
        const bottomBtnGeo = new THREE.ExtrudeGeometry(bottomBtnShape, { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        bottomBtnGeo.center();
        const bottomButton = new THREE.Mesh(bottomBtnGeo, matBlack);
        bottomButton.rotation.x = THREE.MathUtils.degToRad(-90);
        bottomButton.position.set(0, -1.1, 0.3 - 0.1);
        bottomButton.name = 'RESTART_BUTTON';
        bottomButton.userData.originalMat = matBlack;
        chassis.add(bottomButton);
        clickableObjects.push(bottomButton);

        scene.add(deviceGroup);

        // --- INTERACTION LOGIC ---
        function onInteractionClick(event) { // RENAMED FROM onPointerDown
            // Exit if in 360 mode, as dragging takes over
            if (is360Mode) return;
            
            // CRITICAL: Start background audio on first interaction
            AudioManager.startBackground();

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);

            if (intersects.length > 0) {
                let interactiveElement = intersects[0].object;
                
                // Get the intersection point in the object's local space for accurate quadrant detection
                const intersection = intersects[0];
                const localPoint = intersection.point.clone();
                interactiveElement.worldToLocal(localPoint);

                // Check if the click occurred on the 3D dial rim
                if (interactiveElement.parent && interactiveElement.parent.name === 'VOLUME_DIAL_RIM') {
                    // Treat the rim group itself as the interactive element for visual feedback
                    interactiveElement = interactiveElement.parent;
                    
                    const dialCenter = new THREE.Vector3(0, 0, 0); // Dial center in dialGroup local space
                    const relativeX = localPoint.x - dialCenter.x;
                    const relativeY = localPoint.y - dialCenter.y;
                    
                    // Use a stronger vertical bias to ensure the bottom quadrant is easily clickable
                    const isHorizontal = Math.abs(relativeX) > Math.abs(relativeY) * 0.7; // Reduced sensitivity for X axis

                    if (isHorizontal) {
                        if (relativeX > 0) {
                            AudioManager.playNextTrack(); // Right
                        } else {
                            AudioManager.playPrevTrack(); // Left
                        }
                    } else {
                        // Vertical checks (Top/Bottom)
                        if (relativeY > 0) {
                            AudioManager.volumeUp(); // Top
                        } else {
                            // FIX: Ensure Bottom Quadrant triggers Volume Down
                            AudioManager.volumeDown(); // Bottom 
                        }
                    }
                } 
                
                // Check if the click was on the central play/pause button
                else if (interactiveElement.name === 'PLAY_PAUSE_BUTTON') {
                    toggleAudioPlayback();
                }

                // Handle core buttons or special buttons
                else if (interactiveElement.name === 'MUSIC_BUTTON') AudioManager.play('music');
                else if (interactiveElement.name === 'STORY_BUTTON') AudioManager.play('story');
                else if (interactiveElement.name === 'CITY_INFO_BUTTON') AudioManager.play('info');
                else if (interactiveElement.name === 'RECORD_BUTTON') {
                    AudioManager.toggleRecord(
                        () => { 
                            // ON START: Red LED ON
                            redDotLED.material = matRedLED;
                            showMessage("Recording... Click again to stop.", 50000); 
                        }, 
                        () => { 
                            // ON STOP: Black LED OFF
                            redDotLED.material = matBlackDot; 
                        } 
                    );
                } else if (interactiveElement.name === 'RESTART_BUTTON') {
                    showConfirmModal(); // Show confirmation modal instead of immediate reload
                }

                // Apply visual press for all interactive elements (dial rim is handled above)
                const originalZ = interactiveElement.position.z;
                const originalY = interactiveElement.position.y;
                const originalScale = interactiveElement.scale.clone();
                let momentaryMaterial = matGrayPress;

                if (interactiveElement.name === 'VOLUME_DIAL_RIM') {
                    interactiveElement.children.forEach(child => child.material = momentaryMaterial);
                }
                
                // Apply momentary material to all functional buttons
                if (['MUSIC_BUTTON', 'STORY_BUTTON', 'CITY_INFO_BUTTON', 'RECORD_BUTTON'].includes(interactiveElement.name)) {
                    interactiveElement.material = momentaryMaterial;
                }

                if (interactiveElement.name === 'RESTART_BUTTON') interactiveElement.position.y += 0.01;
                else interactiveElement.position.z -= 0.01;
                interactiveElement.scale.set(0.98, 0.98, 0.98);

                // 3. Release (Revert)
                setTimeout(() => {
                    if (interactiveElement.name === 'RESTART_BUTTON') interactiveElement.position.y = originalY;
                    else interactiveElement.position.z = originalZ;
                    interactiveElement.scale.copy(originalScale);
                    
                    // Revert Materials
                    if (interactiveElement.name === 'VOLUME_DIAL_RIM') {
                        // Revert children materials back to black
                        interactiveElement.children.forEach(child => child.material = matBlack);
                    } else if (interactiveElement.name !== 'PLAY_PAUSE_BUTTON') {
                        interactiveElement.material = interactiveElement.userData.originalMat || matBlack;
                    }
                }, 150);
            }
        }
        
        // --- MODAL / WARNING LOGIC ---
        function showConfirmModal() {
            const modalOverlay = document.getElementById('confirm-modal-overlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'flex';
                setTimeout(() => modalOverlay.style.opacity = 1, 10);
                AudioManager.stopAll(); // Pause all audio when modal is up
            }
        }

        function hideConfirmModal() {
            const modalOverlay = document.getElementById('confirm-modal-overlay');
            if (modalOverlay) {
                modalOverlay.style.opacity = 0;
                setTimeout(() => {
                    modalOverlay.style.display = 'none';
                    if (AudioManager.hasInteracted) {
                        AudioManager.play('music'); // Resume music after cancelling restart
                    }
                }, 300);
            }
        }

        document.getElementById('confirm-cancel')?.addEventListener('click', hideConfirmModal);
        document.getElementById('confirm-restart')?.addEventListener('click', () => {
            showMessage("System Restarting...", 3000);
            setTimeout(() => location.reload(), 1000);
        });
        
        // Global state and 360 view management
        let currentTarget = null; 

        // Function to handle 360 mode
        function toggle360Mode(enable) {
            is360Mode = enable;
            const nav = document.querySelector('nav');
            const exitButton = document.getElementById('btn-360-exit-bottom');
            const toggleButton = document.getElementById('btn-360-toggle');
            const overlays = document.querySelectorAll('.main-content-overlay');
            const sections = document.querySelectorAll('.content-section');
            const scrollIndicator = document.querySelector('.scroll-indicator'); 
            const navExitButton = document.getElementById('btn-360-exit');
            const toggleGroup = document.querySelector('.toggle-group');

            // Hide/Show all non-critical UI elements
            const elementsToToggle = [...overlays, ...sections, scrollIndicator]; 

            elementsToToggle.forEach(el => {
                if (el) {
                    el.style.opacity = enable ? 0 : 1;
                    el.style.pointerEvents = enable ? 'none' : 'auto';
                }
            });
            
            // Handle nav bar and footer visibility separately
            if (nav) {
                nav.style.opacity = enable ? 0 : 1;
                nav.style.pointerEvents = enable ? 'none' : 'auto';
            }
            const footer = document.querySelector('footer');
            if (footer) {
                footer.style.opacity = enable ? 0 : 1;
            }

            // Toggle bottom exit/toggle buttons group
            if (toggleGroup) {
                toggleGroup.style.opacity = enable ? 1 : 1;
                toggleGroup.style.pointerEvents = 'auto'; 
            }
            
            if (exitButton) {
                exitButton.style.opacity = enable ? 1 : 0;
                exitButton.style.pointerEvents = enable ? 'auto' : 'none';
            }
            
            if (toggleButton) {
                 toggleButton.style.opacity = enable ? 0 : 1; 
                 toggleButton.style.pointerEvents = enable ? 'none' : 'auto';
            }
            
            document.body.style.overflowY = enable ? 'hidden' : 'auto'; // Re-enable scroll on exit

            if (enable) {
                // Center model target
                currentTarget = { cam: {x:0, y:0, z:5}, rot: {x:0, y:0, z:0} };
                container.style.cursor = 'grab';
                showMessage("360° View Enabled. Drag to rotate.", 3000);
                
                // Pause scroll arrow animation if it exists
                if (scrollIndicator) scrollIndicator.classList.add('paused'); 
            } else {
                // Resume scroll arrow animation
                if (scrollIndicator) scrollIndicator.classList.remove('paused');
                
                // Exit 360 mode: Reset state and jump back to the 'front' view target
                currentTarget = targets['front'];
                container.style.cursor = 'auto';
                // Re-enable scroll observers for UI elements
                updateScroll(); 
            }
        }
        
        // Add event listeners for 360 buttons
        document.getElementById('btn-360-toggle')?.addEventListener('click', () => {
            toggle360Mode(true);
        });
        document.getElementById('btn-360-exit-bottom')?.addEventListener('click', () => {
            toggle360Mode(false);
        });
        document.getElementById('btn-360-exit')?.addEventListener('click', () => {
            // This is the old top button, ensuring it does nothing when disabled
            if (document.getElementById('btn-360-exit').style.opacity > 0) toggle360Mode(false);
        });


        // Event handler functions for mouse/touch interactions
        function onMouseDown(event) {
            if (is360Mode) {
                isDragging = true;
                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
                container.style.cursor = 'grabbing';
            } else {
                onInteractionClick(event); // Existing click logic
            }
        }

        function onMouseMove(event) {
            if (is360Mode && isDragging) {
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;

                // Rotation speed adjustment
                const rotationSpeed = 0.005; 

                deviceGroup.rotation.y += deltaX * rotationSpeed;
                deviceGroup.rotation.x += deltaY * rotationSpeed;
                
                // Clamp rotation to prevent flipping
                deviceGroup.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, deviceGroup.rotation.x));

                previousMousePosition.x = event.clientX;
                previousMousePosition.y = event.clientY;
            }
        }

        function onMouseUp() {
            isDragging = false;
            if (is360Mode) container.style.cursor = 'grab';
        }

        // Setup Mouse/Touch Listeners
        container.addEventListener('mousedown', onMouseDown, false);
        container.addEventListener('mousemove', onMouseMove, false);
        container.addEventListener('mouseup', onMouseUp, false);

        container.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            onMouseDown({ clientX: touch.clientX, clientY: touch.clientY });
        }, false);

        container.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            onMouseMove({ clientX: touch.clientX, clientY: touch.clientY });
        }, false);

        container.addEventListener('touchend', onMouseUp, false);


        // --- SCROLL ANIMATION ---
        const targets = {
            'front': { cam: {x:0, y:-0.8, z:8.5}, rot: {x:0, y:0, z:0} },
            'functional': { cam: {x:0.5, y:0, z:5}, rot: {x:0, y:0.25, z:0} },
            'universal': { cam: {x:-0.5, y:0, z:5}, rot: {x:0, y:-0.25, z:0} },
            // Camera position raised for last phase, and rotated to show bottom face
            'specs': { cam: {x:0, y:0.8, z:7}, rot: {x:THREE.MathUtils.degToRad(-90), y:0, z:0} } 
        };
        let currentSection = 'front';
        const heroContent = document.querySelector('#front .fade-in-section');


        function updateScroll() {
            // Recalculates which section is currently visible based on scroll position
            const sections = ['front', 'functional', 'universal', 'specs'];
            let bestMatch = sections[0];
            let maxVis = 0;
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                // Check visible height of section within viewport
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                if (visibleHeight > maxVis) { maxVis = visibleHeight; bestMatch = id; }
            });
            currentSection = bestMatch;
            
            // Set currentTarget for animate loop based on scroll position if not in 360 mode
            if (!is360Mode) {
                currentTarget = targets[currentSection];
            }

            // OVERLAY CONTROL LOGIC (Fixed overlays based on current section)
            const functionalOverlay = document.getElementById('functional-card-overlay');
            const universalCardOverlay = document.getElementById('universal-card-overlay');
            const maintenanceAccessOverlay = document.getElementById('maintenance-access-overlay');
            const maintenanceRestartOverlay = document.getElementById('maintenance-overlay');
            
            // Function to set opacity and pointer events
            const setOverlayVisibility = (element, visible) => {
                if (!element) return;
                element.style.opacity = visible ? 1 : 0;
                element.style.pointerEvents = visible ? 'auto' : 'none';
            };

            // Calculate visibility based on scroll and 360 mode
            setOverlayVisibility(functionalOverlay, currentSection === 'functional' && !is360Mode);
            setOverlayVisibility(universalCardOverlay, currentSection === 'universal' && !is360Mode);
            setOverlayVisibility(maintenanceAccessOverlay, currentSection === 'specs' && !is360Mode);
            setOverlayVisibility(maintenanceRestartOverlay, currentSection === 'specs' && !is360Mode);
            
            // NEW: Hero Fade-Out Logic
            const scrollDistance = window.scrollY;
            const fadeEnd = window.innerHeight * 0.75; // Fade out by 75% of the first viewport
            
            let opacity = 1;
            let visibility = true;

            if (currentSection !== 'front') {
                // If past the front section, hero is fully invisible
                opacity = 0;
                visibility = false;
            } else if (scrollDistance > 0) {
                // While scrolling on the front page, fade it out
                opacity = 1 - (scrollDistance / fadeEnd);
                opacity = Math.max(0, opacity); // Clamp between 0 and 1
            }
            
            if (heroContent) {
                heroContent.style.opacity = opacity;
                heroContent.style.pointerEvents = visibility ? 'auto' : 'none';
                heroContent.style.transform = `translateY(${scrollDistance * 0.5}px)`; // Add slight parallax lift
            }

        }
        window.addEventListener('scroll', updateScroll);
        // Call once on load to initialize visibility
        updateScroll(); 


        function animate() {
            requestAnimationFrame(animate);
            const tgt = currentTarget; // Use the dynamically set target
            
            if(tgt) {
                // Camera position smoothing
                camera.position.x += (tgt.cam.x - camera.position.x) * 0.05;
                camera.position.y += (tgt.cam.y - camera.position.y) * 0.05;
                camera.position.z += (tgt.cam.z - camera.position.z) * 0.05;

                // Rotation smoothing (Only if not actively dragging)
                if (!isDragging && !is360Mode) {
                    deviceGroup.rotation.x += (tgt.rot.x - deviceGroup.rotation.x) * 0.05;
                    deviceGroup.rotation.y += (tgt.rot.y - deviceGroup.rotation.y) * 0.05;
                    deviceGroup.rotation.z += (tgt.rot.z - deviceGroup.rotation.z) * 0.05;
                }
            }
            deviceGroup.position.y = Math.sin(Date.now() * 0.001) * 0.05;

            // Battery Pulse Effect
            if (currentSection === 'universal') {
                const pulse = (Math.sin(Date.now() * 0.002) + 1) * 1.5 + 0.1; 
                matCyan.emissiveIntensity = pulse;
            } else {
                matCyan.emissiveIntensity += (3.0 - matCyan.emissiveIntensity) * 0.1;
            }

            if (composer) composer.render(); else renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (composer) composer.setSize(window.innerWidth, window.innerHeight);
            updateScroll(); // Recalculate hero fade zone on resize
        });

        // The initial overlay handles the start click now
        const initialOverlay = document.getElementById('audio-start-overlay');
        if (initialOverlay) {
            initialOverlay.addEventListener('click', () => {
                AudioManager.startBackground();
                // This listener should only trigger once to initiate audio
            }, { once: true });
        }


        window.onload = () => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = 0;
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
            // Capture the icon element after the DOM is fully loaded
            playPauseIcon = document.getElementById('play-pause-icon');
            // Initial target setup
            currentTarget = targets['front'];
            // Initial state: Music is playing after the first interaction
            updatePlayPauseIcon(true); 
            animate();
        };

        // --- OVERLAY BUTTON LOGIC ---

        // Restart button now triggers modal
        document.getElementById('btn-restart-overlay')?.addEventListener('click', showConfirmModal);

        // The new overlay play/pause button uses the same logic as the 3D dial
        document.getElementById('btn-play-pause-overlay')?.addEventListener('click', toggleAudioPlayback);

        // Mock Volume/Track controls for overlay buttons
        document.getElementById('btn-prev')?.addEventListener('click', () => AudioManager.playPrevTrack());
        document.getElementById('btn-next')?.addEventListener('click', () => AudioManager.playNextTrack());
        document.getElementById('btn-vol-up')?.addEventListener('click', () => AudioManager.volumeUp());
        document.getElementById('btn-vol-down')?.addEventListener('click', () => AudioManager.volumeDown());
    })();
    </script>
</body>
</html>
