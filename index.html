<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Media Player - Prototype 360 Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Inter', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Custom Scrollbar for panels */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        .glass-panel {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #drop-zone {
            transition: all 0.3s ease;
        }
        #drop-zone.drag-active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- UI Overlay: Header -->
    <div class="absolute top-0 left-0 w-full p-6 pointer-events-none flex justify-between items-start z-10">
        <div>
            <h1 class="text-white text-3xl font-bold tracking-tight drop-shadow-md">Retro Media Player</h1>
            <p class="text-gray-400 text-sm mt-1">Prototype Build 1127150050 â€¢ Interactive Viewer</p>
        </div>
        <div class="pointer-events-auto flex gap-3">
             <button onclick="resetCamera()" class="glass-panel text-white px-4 py-2 rounded-lg text-sm hover:bg-white/10 transition-colors">
                Reset View
            </button>
            <button onclick="toggleAutoRotate()" class="glass-panel text-white px-4 py-2 rounded-lg text-sm hover:bg-white/10 transition-colors">
                Toggle Rotation
            </button>
        </div>
    </div>

    <!-- UI Overlay: Instructions / Drop Zone -->
    <div id="drop-zone" class="absolute inset-0 z-50 flex items-center justify-center bg-black/90 transition-opacity duration-500">
        <div class="glass-panel p-12 rounded-2xl max-w-2xl w-full mx-4 text-center border-2 border-dashed border-gray-600">
            <div id="upload-content">
                <div class="mb-6 flex justify-center">
                    <svg class="w-20 h-20 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">Load Prototype Assets</h2>
                <p class="text-gray-400 mb-8 text-lg">
                    Drag and drop your <strong>.obj</strong>, <strong>.mtl</strong>, and <strong>.jpg</strong> files here simultaneously.
                </p>
                <div class="bg-gray-800/50 p-4 rounded-lg text-left text-sm text-gray-300 inline-block">
                    <p class="font-semibold mb-2 text-white">Required Files:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Retro_Media_Player... .obj</li>
                        <li>Retro_Media_Player... .mtl</li>
                        <li>Retro_Media_Player... .jpg</li>
                    </ul>
                </div>
                <div class="mt-8 text-xs text-gray-500">
                    Your files are processed locally in your browser.
                </div>
            </div>
            
            <div id="loading-content" class="hidden flex flex-col items-center">
                <div class="loading-spinner mb-4"></div>
                <h3 class="text-xl text-white font-semibold">Processing Geometry...</h3>
                <p class="text-gray-400 text-sm mt-2">Parsing 300k+ polygons</p>
            </div>

            <div id="error-content" class="hidden">
                <div class="text-red-500 text-5xl mb-4">!</div>
                <h3 class="text-xl text-white font-semibold" id="error-msg">Error loading files</h3>
                <button onclick="location.reload()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded transition-colors">Try Again</button>
            </div>
        </div>
    </div>

    <!-- UI Overlay: Controls -->
    <div id="controls-panel" class="absolute bottom-6 right-6 z-10 glass-panel p-4 rounded-xl w-64 hidden opacity-0 transition-opacity duration-1000 transform translate-y-4">
        <h3 class="text-white font-semibold mb-3 border-b border-gray-700 pb-2">Material Settings</h3>
        
        <div class="mb-4">
            <label class="block text-xs text-gray-400 mb-1">Roughness</label>
            <input type="range" min="0" max="1" step="0.01" value="0.5" id="roughness-slider" class="w-full accent-blue-500">
        </div>
        
        <div class="mb-4">
            <label class="block text-xs text-gray-400 mb-1">Metalness</label>
            <input type="range" min="0" max="1" step="0.01" value="0.1" id="metalness-slider" class="w-full accent-blue-500">
        </div>

        <div class="mb-2">
            <label class="block text-xs text-gray-400 mb-1">Ambient Light</label>
            <input type="range" min="0" max="2" step="0.1" value="0.8" id="ambient-slider" class="w-full accent-blue-500">
        </div>
    </div>

    <script>
        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 2, 15); // Add depth

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(3, 2, 4);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- CONTROLS ---
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 2.0;
        controls.minDistance = 1;
        controls.maxDistance = 10;

        // --- LIGHTING (Studio Setup) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        // Key Light
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(5, 5, 5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // Rim Light (Blue-ish)
        const rimLight = new THREE.SpotLight(0x4455ff, 2.0);
        rimLight.position.set(-5, 2, -5);
        rimLight.lookAt(0, 0, 0);
        scene.add(rimLight);

        // Fill Light (Warm)
        const fillLight = new THREE.PointLight(0xffaa00, 0.5);
        fillLight.position.set(-5, 0, 5);
        scene.add(fillLight);

        // Grid Floor
        const gridHelper = new THREE.GridHelper(20, 40, 0x444444, 0x222222);
        scene.add(gridHelper);

        // --- FILE HANDLING LOGIC ---
        const dropZone = document.getElementById('drop-zone');
        const uploadContent = document.getElementById('upload-content');
        const loadingContent = document.getElementById('loading-content');
        const errorContent = document.getElementById('error-content');
        const controlsPanel = document.getElementById('controls-panel');
        let loadedObject = null;

        // Drag effects
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });

        // Drop Handler
        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            const fileMap = {};
            
            // Organize files by extension
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (ext === 'obj') fileMap.obj = file;
                else if (ext === 'mtl') fileMap.mtl = file;
                else if (ext === 'jpg' || ext === 'png' || ext === 'jpeg') fileMap.texture = file;
            }

            if (!fileMap.obj || !fileMap.mtl) {
                showError("Missing .obj or .mtl file. Please drop all files together.");
                return;
            }

            // Start Loading UI
            uploadContent.classList.add('hidden');
            loadingContent.classList.remove('hidden');

            loadModel(fileMap);
        }

        function loadModel(fileMap) {
            const manager = new THREE.LoadingManager();
            
            // 1. Create Blob URL for Texture
            let textureUrl = null;
            if (fileMap.texture) {
                textureUrl = URL.createObjectURL(fileMap.texture);
            }

            // 2. Load MTL
            const mtlLoader = new THREE.MTLLoader(manager);
            
            // We need to read the MTL as text first to fix the PNG/JPG path issue manually
            const reader = new FileReader();
            reader.onload = function(e) {
                let mtlText = e.target.result;
                
                // CRITICAL FIX: The MTL file references a .png, but user might upload .jpg
                // We replace any map_Kd reference with our blob URL
                if (textureUrl) {
                    // Regex to find map_Kd line and replace filename
                    mtlText = mtlText.replace(/map_Kd\s+.+/g, `map_Kd ${textureUrl}`);
                }

                // Parse the modified MTL content
                const materials = mtlLoader.parse(mtlText);
                materials.preload();

                // 3. Load OBJ
                const objLoader = new THREE.OBJLoader(manager);
                objLoader.setMaterials(materials);
                
                const objReader = new FileReader();
                objReader.onload = function(e) {
                    const objText = e.target.result;
                    const object = objLoader.parse(objText);
                    
                    onModelLoaded(object);
                };
                objReader.readAsText(fileMap.obj);
            };
            reader.readAsText(fileMap.mtl);
        }

        function onModelLoaded(object) {
            loadedObject = object;

            // Normalize scale and position
            const box = new THREE.Box3().setFromObject(object);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim; // Scale to fit in view

            object.scale.set(scale, scale, scale);
            object.position.sub(center.multiplyScalar(scale)); // Center at 0,0,0
            
            // Lift slightly so it sits on grid
            object.position.y += (size.y * scale) / 2;

            // Better shadows for all meshes
            object.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                    // Apply nice material properties if texture is loaded but looks flat
                    if (child.material) {
                        child.material.roughness = 0.5;
                        child.material.metalness = 0.1;
                    }
                }
            });

            scene.add(object);

            // Hide Loading Overlay
            dropZone.style.opacity = '0';
            setTimeout(() => {
                dropZone.style.display = 'none';
                controlsPanel.classList.remove('hidden');
                // Trigger fade in
                setTimeout(() => {
                    controlsPanel.classList.remove('opacity-0', 'translate-y-4');
                }, 50);
            }, 500);
        }

        function showError(msg) {
            loadingContent.classList.add('hidden');
            uploadContent.classList.add('hidden');
            errorContent.classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- UI HANDLERS ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function resetCamera() {
            camera.position.set(3, 2, 4);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        function toggleAutoRotate() {
            controls.autoRotate = !controls.autoRotate;
        }

        // Material Sliders
        document.getElementById('roughness-slider').addEventListener('input', (e) => {
            if (!loadedObject) return;
            loadedObject.traverse((child) => {
                if (child.isMesh && child.material) child.material.roughness = parseFloat(e.target.value);
            });
        });

        document.getElementById('metalness-slider').addEventListener('input', (e) => {
            if (!loadedObject) return;
            loadedObject.traverse((child) => {
                if (child.isMesh && child.material) child.material.metalness = parseFloat(e.target.value);
            });
        });

        document.getElementById('ambient-slider').addEventListener('input', (e) => {
            ambientLight.intensity = parseFloat(e.target.value);
        });

    </script>
</body>
</html>
