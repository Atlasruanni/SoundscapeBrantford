<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brantford Soundscape Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- POST-PROCESSING SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/LuminosityShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/LuminosityHighPassShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            overflow-x: hidden; 
            background-color: #000000; 
            /* Added Background Image */
            background-image: url('Background.png');
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            color: #f5f5f7;
        }
        
        body.noscroll {
            overflow: hidden;
        }

        /* Hide UI elements when dragging in 360 view */
        body.hide-ui > *:not(#canvas-container) {
            opacity: 0 !important;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        html { scroll-behavior: auto; }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            outline: none;
            pointer-events: auto; 
        }

        .content-section {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            align-items: center;
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.8s ease-in-out;
        }
        
        .content-section.is-visible {
            opacity: 1;
        }
        
        .glass-card {
            pointer-events: auto;
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(44, 44, 46, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .section-title {
            letter-spacing: -0.03em;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); 
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            animation: pulse 2s infinite;
            opacity: 0.5;
        }

        @keyframes pulse {
            0% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
            50% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            100% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
        }

        .loader {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: #000000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        
        nav {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-link {
            position: relative;
            color: #86868b;
            transition: color 0.3s;
            font-size: 12px;
        }
        .nav-link:hover { color: #fff; }

        #audio-start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 500;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s;
            pointer-events: auto;
            cursor: pointer;
        }
        #audio-start-overlay.hidden {
             opacity: 0;
             pointer-events: none;
        }

        #message-box {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            font-size: 14px;
        }

        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

    </style>
</head>
<body class="text-slate-200 antialiased noscroll">

    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-r-2 border-yellow-500 mb-4"></div>
            <p class="text-[10px] font-bold tracking-[0.3em] text-zinc-500 uppercase">Loading Experience</p>
        </div>
    </div>
    
    <div id="audio-start-overlay" class="flex flex-col items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500 mb-4 animate-pulse"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/><path d="M10 8l6 4-6 4V8z"/></svg>
        Tap Anywhere to Start Soundscape
    </div>

    <div id="message-box"></div>
    <div id="canvas-container"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 px-6 md:px-12 py-4 flex justify-between items-center pointer-events-auto">
        <div class="text-lg font-bold tracking-tighter text-white">
            BRANTFORD.<span class="text-yellow-500">SOUNDSCAPE</span>
        </div>
        <div class="hidden md:flex gap-8 font-medium">
            <a href="#front" class="nav-link">Main</a>
            <a href="#functional" class="nav-link">Function</a>
            <a href="#universal" class="nav-link">Control</a>
            <a href="#specs" class="nav-link">Access</a>
            <a href="#view360" class="nav-link text-yellow-500">360° View</a>
        </div>
    </nav>
    
    <!-- Restart Overlay -->
    <div id="maintenance-overlay" class="fixed bottom-40 left-1/2 transform -translate-x-1/2 p-3 rounded-xl bg-red-900/10 border-red-500/20 transition-opacity duration-500 z-40 opacity-0 pointer-events-none">
        <button id="btn-restart-overlay" class="p-3 rounded-full bg-red-600 hover:bg-red-500 transition duration-200 text-white font-bold text-sm pointer-events-auto flex items-center gap-2" title="System Restart">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
            SYSTEM RESTART
        </button>
    </div>

    <!-- 1. Main -->
    <section id="front" class="content-section justify-center text-center px-6">
        <div class="max-w-4xl mx-auto mt-[40vh] md:mt-[35vh]">
            <h1 class="section-title text-5xl md:text-8xl font-bold mb-6 text-white">
                Public Atmosphere.<br>Reimagined.
            </h1>
            <p class="text-zinc-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed font-light dark-text-shadow">
                An interactive audio experience designed to enhance community connection and deliver real-time information to Brantford.
            </p>
        </div>
        <div class="scroll-indicator text-zinc-500 text-xs font-medium tracking-widest uppercase">Scroll</div>
    </section>

    <!-- 2. Function -->
    <section id="functional" class="content-section justify-start px-6 md:px-24">
        <div class="w-full max-w-md">
            <h2 class="section-title text-4xl font-bold mb-8 text-white">Core Functions.</h2>
            <div class="bento-grid">
                <!-- Music -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                    <div class="text-yellow-400 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-1">Music <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠍⠥⠎⠊⠉</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Curated, calming soundscapes for safer streets.</p>
                    </div>
                </div>
                <!-- Story -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                      <div class="text-yellow-400 mb-2">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                      </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-1">Story <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠎⠞⠕⠗⠽</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Local history and culture fostering connection.</p>
                    </div>
                </div>
                <!-- City Info -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                      <div class="text-yellow-400 mb-2">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                      </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-1">City Info <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠉⠊⠞⠽ ⠊⠝⠋⠕</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">AI-powered updates on weather & events.</p>
                    </div>
                </div>
                <!-- Record -->
                <div class="glass-card p-6 flex flex-col justify-between h-40 bg-zinc-800/80 border-zinc-600/30">
                      <div class="text-red-500 mb-2 animate-pulse">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" /></svg>
                      </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm mb-1">Record <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠗⠑⠉⠕⠗⠙</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Leave feedback or messages for the community.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Control -->
    <section id="universal" class="content-section justify-end px-6 md:px-24">
        <div class="w-full max-w-sm text-right">
            <h2 class="section-title text-4xl font-bold mb-6 text-white">Universal Control.</h2>
            <div id="tactile-card" class="glass-card p-8 inline-block text-left w-full">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Tactile Dial</h3>
                        <p class="text-xs text-zinc-500 uppercase tracking-widest">Interface</p>
                    </div>
                </div>
                <p class="text-zinc-300 text-sm leading-relaxed">
                    A single, intuitive dial controls volume and playback using globally recognized symbols.
                    <span class="text-white block mt-2 font-medium">The large green button serves as a dynamic battery indicator, the brightness level shows charge status and device health.</span>
                </p>
                <div id="universal-overlay" class="mt-8 transition-opacity duration-500">
                    <div id="overlay-controls-container" class="glass-card p-4 pointer-events-auto w-full mx-auto" style="border-radius: 30px; border: none; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px);">
                        <div id="overlay-controls" class="flex justify-around items-center space-x-2 text-white">
                            <button id="btn-vol-up" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Volume Up"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg></button>
                            <button id="btn-prev" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Previous Track"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg></button>
                            <button id="btn-play-pause-overlay" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Play/Pause"><svg id="play-pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500"><path d="M3 22v-20l18 10-18 10z"/></svg></button>
                            <button id="btn-next" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Next Track"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg></button>
                            <button id="btn-vol-down" class="w-12 h-12 p-2 rounded-full hover:bg-white/20 transition duration-200" title="Volume Down"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. Access -->
    <section id="specs" class="content-section min-h-screen flex flex-col justify-start items-center px-6 pt-32 relative">
        <div class="w-full max-w-3xl">
            <div class="glass-card p-1 flex items-center gap-4 bg-red-900/10 border-red-500/20">
                <div class="bg-red-500/10 p-4 h-full flex items-center rounded-xl">
                    <span class="text-red-500 font-bold text-xs uppercase tracking-wider rotate-180" style="writing-mode: vertical-rl;">Admin</span>
                </div>
                <div class="py-4 pr-6">
                    <h3 class="text-white font-bold text-lg">Maintenance Access</h3>
                    <p class="text-zinc-400 text-sm mt-1">
                        The <span class="text-red-400">Restart Button</span> is concealed on the bottom face, accessible only to City staff for secure resetting and diagnostics.
                    </p>
                </div>
            </div>
        </div>
        <div class="scroll-indicator text-zinc-500 text-xs font-medium tracking-widest uppercase mt-8">Scroll for 360° View</div>
    </section>

    <!-- 5. 360 Degree View -->
    <section id="view360" class="content-section justify-center items-end px-6 pb-24 cursor-grab">
        <div class="text-center mb-12 pointer-events-none">
            <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md px-6 py-3 rounded-full border border-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
                <span class="text-sm font-bold text-white uppercase tracking-wider">Drag to Rotate 360°</span>
            </div>
        </div>
        <footer class="absolute bottom-6 w-full text-center text-white/50 text-xs tracking-wider uppercase">
            Designed for Brantford &copy; 2025
        </footer>
    </section>

    <script>
    function showMessage(text, duration = 3000) {
        const box = document.getElementById('message-box');
        if (!box) return;
        box.textContent = text;
        box.style.opacity = 1;
        setTimeout(() => { box.style.opacity = 0; }, duration);
    }
    
    let isPlaying = true; 
    let playPauseIcon = null;

    function updatePlayPauseIcon(playing) {
        if (!playPauseIcon) return;
        playPauseIcon.innerHTML = playing ? 
            `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : 
            `<path d="M3 22v-20l18 10-18 10z"/>`;
    }

    // AUDIO MANAGER
    const AudioManager = {
        trackList: ['jazz-background-music-333352.mp3', 'jazz-background-music-338663.mp3', 'jazz-background-music-379027.mp3', 'jazz-background-music-426859.mp3'],
        currentTrackIndex: 0, audioElement: null,
        sources: { recordBeep: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg') },
        current: null, isRecording: false, recorder: null, stream: null, hasInteracted: false,
        voices: [],

        // Content Libraries - Extended Paragraphs
        storyContent: [
            "Brantford is proudly known worldwide as the Telephone City. It was here, at his family's homestead—Melville House—on a humid summer day in 1874, that Alexander Graham Bell first conceived the revolutionary idea of the telephone. Just two years later, he proved his invention worked by successfully receiving a clear long-distance transmission from Paris, Ontario, forever changing how humanity connects.",
            "Art lovers know Brantford as the birthplace of Lawren Harris, a founder of the iconic Group of Seven. Born here in 1885, his childhood home still stands on West Colborne Street. The wealthy industrial atmosphere of turn-of-the-century Brantford provided the backdrop for his early life before he ventured north to paint the stark, spiritual landscapes that defined Canadian art.",
            "Her Majesty's Royal Chapel of the Mohawks is a site of profound significance. Built in 1785, it is the oldest surviving church in Ontario and the first Protestant church in Upper Canada. It was given to the Mohawk people led by Joseph Brant as a reminder of the alliances formed during the American Revolution, and it remains a designated National Historic Site today.",
            "For hockey fans, Brantford is hallowed ground. This is the hometown of Wayne Gretzky, the Great One. Visitors often flock to the Wayne Gretzky Sports Centre, not just to skate, but to see the inspiring 12-foot bronze statue of Wayne hoisting the Stanley Cup, with statues of his parents, Walter and Phyllis, standing proudly nearby.",
            "In the late 19th century, Brantford was an industrial titan, ranking third in all of Canada for export value. Factories here produced everything from Massey-Harris farm equipment to biscuits and textiles, shipping goods across the British Empire. That blue-collar grit and innovation laid the foundation for the resilient community we see today.",
            "The Grand River, a designated Canadian Heritage River, is the lifeblood of our landscape. It winds through the city offering some of the best fly-fishing for steelhead trout in the province. The extensive trail system along its banks allows residents to walk, cycle, and find a moment of peace right in the heart of the city."
        ],
        
        // Dynamic City Info Generator - Broadcast Style
        getCityInfo() {
            const time = new Date();
            const hour = time.getHours();
            const minutes = time.getMinutes();
            const timeString = `${hour % 12 || 12}:${minutes < 10 ? '0' + minutes : minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
            
            // Greetings based on time
            let greeting = "Good morning";
            if(hour >= 12 && hour < 17) greeting = "Good afternoon";
            else if(hour >= 17) greeting = "Good evening";

            // Random Weather Snippets
            const weather = [
                "skies are currently clear with a pleasant temperature of 22 degrees",
                "we are seeing some overcast clouds with a chance of light rain later this evening",
                "it is a sunny and bright day, perfect for outdoor activities",
                "winds are picking up slightly from the west, bringing cooler temperatures"
            ];
            const selectedWeather = weather[Math.floor(Math.random() * weather.length)];

            // Random Local Updates
            const news = [
                "In traffic news, construction on King George Road is causing minor delays, so please plan your route accordingly.",
                "Community reminder: The Brantford Public Library is hosting a local author reading series tonight at 7 PM.",
                "If you are heading downtown, the Market Centre Parkade has ample parking available right now.",
                "Don't forget, waste collection for Ward 3 is scheduled for tomorrow morning. Please have your bins out by 7 AM.",
                "Transit update: Route 8 Holmedale is currently running five minutes behind schedule."
            ];
            const selectedNews = news[Math.floor(Math.random() * news.length)];

            return `${greeting}, Brantford. It is currently ${timeString}. The ${selectedWeather}. ${selectedNews}. Stay safe and enjoy your day.`;
        },

        init() {
            this.audioElement = new Audio();
            this.audioElement.loop = false; 
            this.audioElement.volume = 0.5;
            this.sources.recordBeep.volume = 0.7;
            this.loadTrack(this.currentTrackIndex);
            this.audioElement.addEventListener('ended', () => { if (this.current === 'music' && isPlaying) this.playNextTrack(); });
            
            // Init Voices - Attempt to load immediately and on change
            const loadVoices = () => {
                this.voices = window.speechSynthesis.getVoices();
            };
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
        },
        loadTrack(index) {
            this.currentTrackIndex = (index % this.trackList.length + this.trackList.length) % this.trackList.length;
            this.audioElement.src = this.trackList[this.currentTrackIndex];
            this.audioElement.load();
            if (isPlaying && this.hasInteracted) this.audioElement.play().catch(e => console.log("Resume failed"));
        },
        playNextTrack() { this.loadTrack(this.currentTrackIndex + 1); showMessage(`Next Track: ${this.currentTrackIndex + 1}`, 2000); },
        playPrevTrack() { this.loadTrack(this.currentTrackIndex - 1); showMessage(`Prev Track: ${this.currentTrackIndex + 1}`, 2000); },
        volumeUp() { this.audioElement.volume = Math.min(1.0, this.audioElement.volume + 0.1); showMessage(`Vol: ${Math.round(this.audioElement.volume * 100)}%`, 1000); },
        volumeDown() { this.audioElement.volume = Math.max(0.0, this.audioElement.volume - 0.1); showMessage(`Vol: ${Math.round(this.audioElement.volume * 100)}%`, 1000); },
        startBackground() { if(!this.hasInteracted) { this.hasInteracted = true; hideInitialOverlay(); this.play('music'); } },
        stopBackgroundMusic() { this.audioElement.pause(); isPlaying = false; updatePlayPauseIcon(false); },
        stopAll() { this.audioElement.pause(); window.speechSynthesis.cancel(); this.current = null; isPlaying = false; updatePlayPauseIcon(false); },
        play(type) {
            if(this.isRecording) return;
            if (type === 'music') {
                 if (this.current === 'music' && !this.audioElement.paused) return; 
                 if (this.current === 'story' || this.current === 'info') window.speechSynthesis.cancel();
                 this.audioElement.currentTime = 0; 
                 this.audioElement.play().catch(e => showMessage("Audio restricted. Interact first.", 3000)); 
                 this.current = 'music'; isPlaying = true; updatePlayPauseIcon(true); return;
            }
            this.stopAll();
            if (type === 'story' || type === 'info') {
                let text = "";
                if (type === 'story') {
                    // Pick random story
                    text = this.storyContent[Math.floor(Math.random() * this.storyContent.length)];
                    showMessage("Playing Local History...", 3000);
                } else {
                    // Generate dynamic info
                    text = this.getCityInfo();
                    showMessage("Broadcasting City Info...", 3000);
                }
                
                const u = new SpeechSynthesisUtterance(text);
                
                // Voice Selection Logic: Prioritize Google, then "Natural", then default
                // This tries to find a higher quality voice than the robotic default
                if (this.voices.length > 0) {
                    const preferredVoice = this.voices.find(v => v.name.includes('Google US English')) || 
                                           this.voices.find(v => v.name.includes('Google UK English Female')) ||
                                           this.voices.find(v => v.name.includes('Natural')) ||
                                           this.voices.find(v => v.lang === 'en-US');
                    if (preferredVoice) {
                        u.voice = preferredVoice;
                    }
                }

                u.rate = 0.9; // Slightly slower is usually more intelligible and natural for TTS
                u.pitch = 1.0;
                
                window.speechSynthesis.speak(u);
                this.current = type;
                u.onend = () => this.play('music'); 
            }
        },
        async toggleRecord(onStart, onStop) {
            if (this.isRecording) {
                if(this.recorder && this.recorder.state !== 'inactive') this.recorder.stop();
                if (this.stream) this.stream.getTracks().forEach(track => track.stop());
                this.isRecording = false; onStop(); this.play('music');
            } else {
                this.stopAll(); this.sources.recordBeep.currentTime = 0; this.sources.recordBeep.play();
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(this.stream);
                    this.recorder.start();
                    this.isRecording = true; onStart();
                } catch (e) { onStop(); showMessage("Microphone access denied.", 4000); this.play('music'); }
            }
        }
    };

    function toggleAudioPlayback() {
        if (isPlaying) { AudioManager.stopBackgroundMusic(); isPlaying = false; showMessage("Paused", 1000); }
        else { AudioManager.play('music'); isPlaying = true; showMessage("Resumed", 1000); }
    }
    // CHANGE: Update to remove noscroll class from body
    function hideInitialOverlay() {
        const overlay = document.getElementById('audio-start-overlay');
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('noscroll');
    }

    (function() {
        AudioManager.init();

        // --- SCROLL OBSERVER (UPDATED FOR FADE IN/OUT) ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { 
                // Toggle is-visible based on intersection state to allow fade out
                entry.target.classList.toggle('is-visible', entry.isIntersecting);
            });
        }, { threshold: 0.1 });
        // Select all direct children that are 'fade-in-section' or the main container inside section
        document.querySelectorAll('.content-section').forEach(section => observer.observe(section));

        // --- THREE.JS CONFIG ---
        const container = document.getElementById('canvas-container');
        if(container.firstChild) container.removeChild(container.firstChild);
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); 
        // CHANGE: Use TextureLoader to load Background.png instead of simple black color
        const textureLoader = new THREE.TextureLoader();
        scene.background = textureLoader.load('Background.png');

        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 10); 
        const renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);
        
        let composer, bloomPass;
        function initPostProcessing() {
            if (typeof THREE.EffectComposer === 'undefined') return;
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));
            bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.3, 0.8);
            composer.addPass(bloomPass);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
        initPostProcessing();

        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clickableObjects = [];
        let redDotLED = null;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let manualRotation = { x: 0, y: 0 };

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.15); scene.add(ambientLight);
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5); mainLight.position.set(5, 5, 10); mainLight.castShadow = true; scene.add(mainLight);
        const topLight = new THREE.SpotLight(0xffffff, 3.0); topLight.position.set(0, 10, 0); scene.add(topLight);
        const fillLight = new THREE.PointLight(0xffaa00, 0.4); fillLight.position.set(-5, 0, 5); scene.add(fillLight);
        
        // CHANGE: Add BOTTOM light to make undercarriage visible
        const bottomLight = new THREE.PointLight(0x444444, 1.0);
        bottomLight.position.set(0, -10, 0);
        scene.add(bottomLight);

        // MATERIALS
        const colorYellow = 0xFFA000; 
        const matBody = new THREE.MeshPhysicalMaterial({ color: colorYellow, roughness: 1.0, metalness: 0.0, clearcoat: 0.0 });
        const matBlack = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.8, metalness: 0.1 });
        const colorGreen = 0x00A060; 
        const matCyan = new THREE.MeshPhysicalMaterial({ color: 0x000000, roughness: 0.9, metalness: 0.0, emissive: colorGreen, emissiveIntensity: 3.0, clearcoat: 0.0 });
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.35, metalness: 0.9 });
        // CHANGE: Removed emissive properties and increased roughness for a "true red" non-lit look
        const matRedLED = new THREE.MeshStandardMaterial({ color: 0xFF0000, roughness: 0.5, metalness: 0.0 });
        const matBlackDot = new THREE.MeshStandardMaterial({ color: 0x010101, roughness: 1.0, metalness: 0.0, emissive: 0x000000 });
        const matGrayPress = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.8, metalness: 0.1 });

        // GEOMETRY
        function createRoundedRect(w, h, r) {
            const shape = new THREE.Shape();
            shape.moveTo(-w/2 + r, h/2); shape.lineTo(w/2 - r, h/2); shape.quadraticCurveTo(w/2, h/2, w/2, h/2 - r);
            shape.lineTo(w/2, -h/2 + r); shape.quadraticCurveTo(w/2, -h/2, w/2 - r, -h/2); shape.lineTo(-w/2 + r, -h/2);
            shape.quadraticCurveTo(-w/2, -h/2, -w/2, -h/2 + r); shape.lineTo(-w/2, h/2 - r); shape.quadraticCurveTo(-w/2, h/2, -w/2 + r, h/2);
            return shape;
        }

        const deviceGroup = new THREE.Group();
        const chassis = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(5.75, 2.2, 0.55), { depth: 0.6, bevelEnabled: true, bevelThickness: 0.08, bevelSize: 0.08, bevelSegments: 6 }), matBody);
        chassis.geometry.center(); deviceGroup.add(chassis);
        const Z_SURFACE = 0.38; 

        // Left Dial
        const dialGroup = new THREE.Group(); dialGroup.position.set(-1.75, 0, Z_SURFACE);
        
        // CHANGE: Split rim into 4 quadrants
        const segs = 4;
        // CHANGE: Reduced gap size from 0.15 to 0.01 for a much smaller gap
        const gap = 0.007; // Radians
        const arc = (Math.PI * 2) / segs - gap;
        const rimGroup = new THREE.Group(); rimGroup.name = 'VOLUME_DIAL_RIM'; rimGroup.userData.originalMat = matBlack; dialGroup.add(rimGroup); clickableObjects.push(rimGroup);
        
        for(let i=0; i<segs; i++) {
            // Centers: 0 (Right), 1 (Top), 2 (Left), 3 (Bottom) -- based on standard circle angle 0 at +X
            const centerAngle = i * (Math.PI/2);
            const startAngle = centerAngle - arc/2;
            
            const dish = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 1.0, 0.15, 32, 1, false, startAngle, arc), matBlack);
            dish.rotation.x = Math.PI/2; 
            dish.position.z = -0.05; 
            // CHANGE: Tag quadrant index
            dish.userData.quadrant = i;
            rimGroup.add(dish);

            const slope = new THREE.Mesh(new THREE.CylinderGeometry(0.56, 0.9, 0.2, 32, 1, true, startAngle, arc), matBlack);
            slope.rotation.x = Math.PI/2; 
            slope.position.z = 0.0; 
            // CHANGE: Tag quadrant index
            slope.userData.quadrant = i;
            rimGroup.add(slope);
        }

        const btn = new THREE.Mesh(new THREE.CylinderGeometry(0.54, 0.54, 0.1, 64), matCyan); btn.rotation.x = Math.PI/2; btn.position.z = 0.02; btn.name = 'PLAY_PAUSE_BUTTON'; btn.userData.originalMat = matCyan;
        dialGroup.add(btn); clickableObjects.push(btn); deviceGroup.add(dialGroup);

        // Speaker
        const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 512; const ctx = cvs.getContext('2d'); ctx.fillStyle = '#000000';
        const gridY = 20; const radius = 7; const padX = 10; const padY = 10; const stepY = (cvs.height - padY*2) / gridY; const baseStepX = (cvs.width - padX*2) / 9;
        for(let y=0; y<=gridY; y++) {
            const numDots = (y % 2 === 0) ? 9 : 10; const rowWidth = baseStepX * (numDots - 1); const centeringOffset = ((cvs.width - padX*2) - rowWidth) / 2;
            for(let x=0; x<numDots; x++) { ctx.beginPath(); ctx.arc(padX + centeringOffset + x * baseStepX, padY + y*stepY, radius, 0, Math.PI*2); ctx.fill(); }
        }
        const spkTex = new THREE.CanvasTexture(cvs);
        const spkPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.0, 1.8), new THREE.MeshPhysicalMaterial({ map: spkTex, color: 0x000000, roughness: 1.0, metalness: 0.0, clearcoat: 0.0, reflectivity: 0.0, transparent: true, alphaTest: 0.1 }));
        spkPlane.position.set(-0.21, 0, Z_SURFACE + 0.01); deviceGroup.add(spkPlane);

        // Buttons
        const padGroup = new THREE.Group(); padGroup.position.set(1.55, 0, Z_SURFACE); 
        const hs = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(2.24, 1.74, 0.25), { depth: 0.05, bevelEnabled: false}), matBlack); hs.geometry.center(); hs.position.z = 0.02; padGroup.add(hs);
        const btnGeom = new THREE.ExtrudeGeometry(createRoundedRect(0.88, 0.66, 0.12), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 }); btnGeom.center();
        const gapX = (2.24 - 2 * 0.88) / 3; const gapY = (1.74 - 2 * 0.66) / 3; const X_OFFSET = (0.88 / 2) + (gapX / 2); const Y_OFFSET = (0.66 / 2) + (gapY / 2);
        const positions = [{ x: -X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'MUSIC_BUTTON' }, { x: X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'STORY_BUTTON' }, { x: -X_OFFSET, y: -Y_OFFSET, mat: matBlack, name: 'CITY_INFO_BUTTON' }, { x: X_OFFSET, y: -Y_OFFSET, mat: matSteel, name: 'RECORD_BUTTON' }];
        positions.forEach((p) => {
            const b = new THREE.Mesh(btnGeom, p.mat); b.position.set(p.x, p.y, 0.04); b.name = p.name; b.userData.originalMat = p.mat;
            if(p.name === 'RECORD_BUTTON') { const dot = new THREE.Mesh(new THREE.CircleGeometry(0.04, 16), matBlackDot); dot.position.set(0.3, -0.2, 0.041); b.add(dot); redDotLED = dot; }
            padGroup.add(b); clickableObjects.push(b);
        });
        deviceGroup.add(padGroup);
        
        // Restart Button (Shifted Center)
        const bottomButton = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(1.0, 0.2, 0.08), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 }), matBlack);
        bottomButton.geometry.center(); bottomButton.rotation.x = THREE.MathUtils.degToRad(-90); 
        // CHANGE: Shifted restart button back to the right to make room for the centered aux button
        bottomButton.position.set(1.5, -1.1, 0.3 - 0.1); 
        bottomButton.name = 'RESTART_BUTTON'; bottomButton.userData.originalMat = matBlack;
        chassis.add(bottomButton); clickableObjects.push(bottomButton);

        // NEW: Bottom Aux Button (Centered, Right)
        // CHANGE: Used ExtrudeGeometry with rounded rect shape to match functional buttons
        // CHANGE: Reverted width to 0.88, made it slimmer by reducing height to 0.3 and radius to 0.08
        const bottomAuxGeo = new THREE.ExtrudeGeometry(createRoundedRect(0.88, 0.3, 0.08), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        bottomAuxGeo.center();
        const botAuxBtn = new THREE.Mesh(bottomAuxGeo, matBlack); // Uses matBlack (same as rim/3 buttons)
        botAuxBtn.rotation.x = THREE.MathUtils.degToRad(90); // Face down
        // CHANGE: Moved to center (0)
        botAuxBtn.position.set(0, -1.15, 0); 
        botAuxBtn.name = 'BOTTOM_AUX_BUTTON';
        botAuxBtn.userData.originalMat = matBlack;
        chassis.add(botAuxBtn);
        clickableObjects.push(botAuxBtn);

        scene.add(deviceGroup);

        function onPointerDown(event) {
            if (currentSection === 'view360') { 
                isDragging = true; 
                previousMousePosition = { x: event.clientX, y: event.clientY }; 
                document.getElementById('view360').classList.add('cursor-grabbing'); 
                document.getElementById('view360').classList.remove('cursor-grab'); 
                // CHANGE: Hide UI on drag start
                document.body.classList.add('hide-ui');
            }

            AudioManager.startBackground();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);
            if (intersects.length > 0) {
                let ie = intersects[0].object;
                const intersection = intersects[0]; const localPoint = intersection.point.clone(); 
                let activeMeshes = []; // Store which meshes to animate

                // CHANGE: Use parent (Group) transformation for accurate quadrant check
                if (ie.parent && ie.parent.name === 'VOLUME_DIAL_RIM') {
                    const rimGroup = ie.parent;
                    const groupLocalPoint = intersection.point.clone();
                    rimGroup.worldToLocal(groupLocalPoint); // Convert to group space which is XY plane aligned
                    
                    const relX = groupLocalPoint.x; 
                    const relY = groupLocalPoint.y;
                    
                    let targetQuad = -1;

                    if (Math.abs(relX) > Math.abs(relY) * 0.7) { 
                        // Horizontal dominant
                        if (relX > 0) { 
                            AudioManager.playNextTrack(); 
                            // CHANGE: Remapped Right to Index 1 (Visual Right)
                            targetQuad = 1; 
                        } else { 
                            AudioManager.playPrevTrack(); 
                            // CHANGE: Remapped Left to Index 3 (Visual Left)
                            targetQuad = 3; 
                        }
                    } else { 
                        // Vertical dominant
                        if (relY > 0) { 
                            AudioManager.volumeUp(); 
                            // CHANGE: Remapped Top to Index 2 (Visual Top)
                            targetQuad = 2; 
                        } else { 
                            AudioManager.volumeDown(); 
                            // CHANGE: Remapped Bottom to Index 0 (Visual Bottom)
                            targetQuad = 0; 
                        }
                    }
                    // Treat group as the interactive element for animation, but filter children
                    ie = ie.parent; 
                    activeMeshes = ie.children.filter(c => c.userData.quadrant === targetQuad);
                } else {
                    ie.worldToLocal(localPoint); // Normal logic for other buttons
                    activeMeshes = [ie]; // For buttons, animate the button itself (except rimGroup children handled differently in loop?)
                    // Actually for buttons 'ie' is the mesh. For rim, 'ie' becomes the Group.
                    // The visual logic below uses ie.material or ie.children.
                }

                if (ie.name === 'PLAY_PAUSE_BUTTON') toggleAudioPlayback();
                else if (ie.name === 'MUSIC_BUTTON') AudioManager.play('music');
                else if (ie.name === 'STORY_BUTTON') AudioManager.play('story');
                else if (ie.name === 'CITY_INFO_BUTTON') AudioManager.play('info');
                else if (ie.name === 'RECORD_BUTTON') AudioManager.toggleRecord(() => { redDotLED.material = matRedLED; showMessage("Recording...", 50000); }, () => { redDotLED.material = matBlackDot; });
                // CHANGE: Added delay and message for Restart Button click instead of instant reload
                else if (ie.name === 'RESTART_BUTTON') {
                    showMessage("System Restarting...", 3000); 
                    setTimeout(() => location.reload(), 1500);
                }
                else if (ie.name === 'BOTTOM_AUX_BUTTON') showMessage("Service Port Accessed.", 2000);

                const oz = ie.position.z; const oy = ie.position.y; const os = ie.scale.clone();
                let momMat = matGrayPress;
                
                // VISUAL FEEDBACK LOGIC
                if (ie.name === 'VOLUME_DIAL_RIM') {
                    // CHANGE: Only light up active meshes for quadrant
                    activeMeshes.forEach(c => c.material = momMat);
                }
                
                if (['MUSIC_BUTTON', 'STORY_BUTTON', 'CITY_INFO_BUTTON', 'RECORD_BUTTON', 'BOTTOM_AUX_BUTTON'].includes(ie.name)) ie.material = momMat;
                if (ie.name === 'RESTART_BUTTON' || ie.name === 'BOTTOM_AUX_BUTTON') ie.position.y += 0.01; else ie.position.z -= 0.01; ie.scale.set(0.98, 0.98, 0.98);
                
                setTimeout(() => {
                    if (ie.name === 'RESTART_BUTTON' || ie.name === 'BOTTOM_AUX_BUTTON') ie.position.y = oy; else ie.position.z = oz; ie.scale.copy(os);
                    
                    if (ie.name === 'VOLUME_DIAL_RIM') {
                        // CHANGE: Revert active meshes only
                        activeMeshes.forEach(c => c.material = matBlack);
                    } else if (ie.name !== 'PLAY_PAUSE_BUTTON') {
                        ie.material = ie.userData.originalMat || matBlack;
                    }
                }, 150);
            }
        }
        function onPointerMove(event) {
            if (isDragging && currentSection === 'view360') {
                const deltaMove = { x: event.clientX - previousMousePosition.x, y: event.clientY - previousMousePosition.y };
                manualRotation.y += deltaMove.x * 0.01; manualRotation.x += deltaMove.y * 0.01;
                previousMousePosition = { x: event.clientX, y: event.clientY };
            }
        }
        function onPointerUp() { 
            if (isDragging) { 
                isDragging = false; 
                document.getElementById('view360').classList.remove('cursor-grabbing'); 
                document.getElementById('view360').classList.add('cursor-grab'); 
                // CHANGE: Show UI and reset model rotation on drag stop
                document.body.classList.remove('hide-ui');
                manualRotation = { x: 0, y: 0 };
            } 
        }

        container.addEventListener('pointerdown', onPointerDown, false);
        container.addEventListener('pointermove', onPointerMove, false);
        container.addEventListener('pointerup', onPointerUp, false);
        container.addEventListener('pointerleave', onPointerUp, false);

        const targets = {
            'front': { cam: {x:0, y:-0.8, z:8.5}, rot: {x:0, y:0, z:0} },
            'functional': { cam: {x:0.5, y:0, z:5}, rot: {x:0, y:0.25, z:0} },
            'universal': { cam: {x:-0.5, y:0, z:5}, rot: {x:0, y:-0.25, z:0} },
            'specs': { cam: {x:0, y:0.8, z:7}, rot: {x:THREE.MathUtils.degToRad(-90), y:0, z:0} },
            'view360': { cam: {x:0, y:0, z:7}, rot: null }
        };
        let currentSection = 'front';

        function updateScroll() {
            const sections = ['front', 'functional', 'universal', 'specs', 'view360'];
            let bestMatch = sections[0]; let maxVis = 0;
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                if (visibleHeight > maxVis) { maxVis = visibleHeight; bestMatch = id; }
            });
            currentSection = bestMatch;
            
            const overlay = document.getElementById('universal-overlay');
            if(overlay) {
                const isVisible = document.getElementById('universal').querySelector('.content-section.is-visible'); // Use generic class
                // Actually the fade logic uses 'is-visible' on the section itself now
                const universalSection = document.getElementById('universal');
                const isUniversalVisible = universalSection.classList.contains('is-visible');
                overlay.style.opacity = isUniversalVisible ? 1 : 0; 
                overlay.style.pointerEvents = isUniversalVisible ? 'auto' : 'none';
            }

            const maintenanceOverlay = document.getElementById('maintenance-overlay');
            if(maintenanceOverlay) {
                // CHANGE: Visibility logic: Show in 'specs' (Access), HIDE in 'view360'
                const showMaint = (currentSection === 'specs'); 
                maintenanceOverlay.style.opacity = showMaint ? 1 : 0; 
                maintenanceOverlay.style.pointerEvents = showMaint ? 'auto' : 'none';
            }
        }
        window.addEventListener('scroll', updateScroll);

        function animate() {
            requestAnimationFrame(animate);
            const tgt = targets[currentSection];
            if(tgt) {
                camera.position.x += (tgt.cam.x - camera.position.x) * 0.05;
                camera.position.y += (tgt.cam.y - camera.position.y) * 0.05;
                camera.position.z += (tgt.cam.z - camera.position.z) * 0.05;

                if (currentSection === 'view360') {
                    // Check if dragging or resetting
                    // CHANGE: Reverted reset speed to 0.05 to match standard page speed
                    const lerpFactor = isDragging ? 0.2 : 0.05; 
                    
                    deviceGroup.rotation.x += (manualRotation.x - deviceGroup.rotation.x) * lerpFactor;
                    deviceGroup.rotation.y += (manualRotation.y - deviceGroup.rotation.y) * lerpFactor;
                    deviceGroup.rotation.z += (0 - deviceGroup.rotation.z) * lerpFactor;
                } else {
                    // CHANGE: Reverted transition speed from 0.005 back to 0.05 for responsive navigation
                    deviceGroup.rotation.x += (tgt.rot.x - deviceGroup.rotation.x) * 0.05;
                    deviceGroup.rotation.y += (tgt.rot.y - deviceGroup.rotation.y) * 0.05;
                    deviceGroup.rotation.z += (tgt.rot.z - deviceGroup.rotation.z) * 0.05;
                    manualRotation.x = 0; manualRotation.y = 0;
                }
            }
            deviceGroup.position.y = Math.sin(Date.now() * 0.001) * 0.05;

            // CHANGE: Battery Cycle - Pulse in UNIVERSAL (Control), Steady in others
            if (currentSection === 'universal') {
                const time = Date.now() * 0.003; 
                const intensity = ((Math.sin(time) + 1) / 2) * 3.0;
                matCyan.emissiveIntensity = intensity;
            } else {
                matCyan.emissiveIntensity += (3.0 - matCyan.emissiveIntensity) * 0.1;
            }
            if (composer) composer.render(); else renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (composer) composer.setSize(window.innerWidth, window.innerHeight);
        });

        const initialOverlay = document.getElementById('audio-start-overlay');
        if (initialOverlay) initialOverlay.addEventListener('click', () => { AudioManager.startBackground(); }, { once: true });

        window.onload = () => {
            const loader = document.getElementById('loader');
            if (loader) { loader.style.opacity = 0; setTimeout(() => { loader.style.display = 'none'; }, 500); }
            playPauseIcon = document.getElementById('play-pause-icon');
            updatePlayPauseIcon(true); 
            animate();
        };

        document.getElementById('btn-restart-overlay')?.addEventListener('click', () => {
             showMessage("System Restarting...", 3000); setTimeout(() => location.reload(), 1000); 
        });
        document.getElementById('btn-play-pause-overlay')?.addEventListener('click', toggleAudioPlayback);
        document.getElementById('btn-prev')?.addEventListener('click', () => AudioManager.playPrevTrack());
        document.getElementById('btn-next')?.addEventListener('click', () => AudioManager.playNextTrack());
        document.getElementById('btn-vol-up')?.addEventListener('click', () => AudioManager.volumeUp());
        document.getElementById('btn-vol-down')?.addEventListener('click', () => AudioManager.volumeDown());
    })();
    </script>
</body>
</html>
