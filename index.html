<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brantford Soundscape Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- POST-PROCESSING SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/LuminosityShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/LuminosityHighPassShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            background-color: #000000; 
            color: #f5f5f7;
        }
        
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Canvas fixed in background */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            outline: none;
            pointer-events: auto; 
        }

        /* Overlay content */
        .content-section {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            align-items: center;
            pointer-events: none; /* Let clicks pass through to canvas by default */
        }
        
        /* Apple-esque Glass Card */
        .glass-card {
            pointer-events: auto; /* Enable interaction with cards */
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, background 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(44, 44, 46, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Typography Enhancements */
        .hero-title {
            background: linear-gradient(180deg, #FFFFFF 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.05em;
        }

        .section-title {
            letter-spacing: -0.03em;
            /* USER REQUEST: Add text shadow to section titles */
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); 
        }

        /* Grid Layouts */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            animation: pulse 2s infinite;
            opacity: 0.5;
        }

        @keyframes pulse {
            0% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
            50% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            100% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
        }

        .loader {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: #000000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        
        /* Navigation Blur */
        nav {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-link {
            position: relative;
            color: #86868b;
            transition: color 0.3s;
            font-size: 12px;
        }
        .nav-link:hover { color: #fff; }

        /* Fade In Animation for text */
        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: none;
        }
        
        /* Audio Start Overlay */
        #audio-start-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Floating Message Box */
        #message-box {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            font-size: 14px;
        }

    </style>
</head>
<body class="text-slate-200 antialiased">

    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-r-2 border-yellow-500 mb-4"></div>
            <p class="text-[10px] font-bold tracking-[0.3em] text-zinc-500 uppercase">Loading Experience</p>
        </div>
    </div>
    
    <div id="audio-start-overlay">Tap anywhere to start sound</div>

    <!-- Feedback Message Box -->
    <div id="message-box"></div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 px-6 md:px-12 py-4 flex justify-between items-center pointer-events-auto">
        <div class="text-lg font-bold tracking-tighter text-white">
            BRANTFORD.<span class="text-yellow-500">SOUNDSCAPE</span>
        </div>
        <div class="hidden md:flex gap-8 font-medium">
            <a href="#front" class="nav-link">Overview</a>
            <a href="#functional" class="nav-link">Features</a>
            <a href="#universal" class="nav-link">Controls</a>
            <a href="#specs" class="nav-link">Tech Specs</a>
        </div>
    </nav>

    <!-- Section 1: Hero / Overview -->
    <section id="front" class="content-section justify-center text-center px-6">
        <div class="fade-in-section max-w-4xl mx-auto mt-[40vh] md:mt-[35vh]">
            <span class="inline-block py-1 px-3 rounded-full border border-yellow-500/30 bg-yellow-500/10 text-yellow-500 text-[10px] font-bold tracking-widest uppercase mb-6">
                Model 2.0
            </span>
            <h1 class="hero-title text-5xl md:text-8xl font-bold mb-6">
                Public Safety.<br>Reimagined.
            </h1>
            <p class="text-zinc-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed font-light">
                An interactive audio experience designed to enhance community connection and deliver real-time information to Brantford.
            </p>
        </div>
        <div class="scroll-indicator text-zinc-500 text-xs font-medium tracking-widest uppercase">Scroll</div>
    </section>

    <!-- Section 2: Functional Keys (Bento Grid Layout) -->
    <section id="functional" class="content-section justify-start px-6 md:px-24">
        <div class="fade-in-section w-full max-w-md">
            <h2 class="section-title text-4xl font-bold mb-8 text-white">Core Functions.</h2>
            
            <div class="bento-grid">
                <!-- Music -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                    <div class="text-yellow-400 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                    </div>
                    <div>
                        <!-- USER REQUEST: Add Braille translation -->
                        <h3 class="text-white font-semibold text-sm mb-1">Music <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠍⠥⠎⠊⠉</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Curated, calming soundscapes for safer streets.</p>
                    </div>
                </div>

                <!-- Story -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                     <div class="text-yellow-400 mb-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                     </div>
                    <div>
                        <!-- USER REQUEST: Add Braille translation -->
                        <h3 class="text-white font-semibold text-sm mb-1">Story <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠎⠞⠕⠗⠽</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Local history and culture fostering connection.</p>
                    </div>
                </div>

                <!-- City Info -->
                <div class="glass-card p-6 flex flex-col justify-between h-40">
                     <div class="text-yellow-400 mb-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                     </div>
                    <div>
                        <!-- USER REQUEST: Add Braille translation -->
                        <h3 class="text-white font-semibold text-sm mb-1">City Info <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠉⠊⠞⠽ ⠊⠝⠋⠕</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">AI-powered updates on weather & events.</p>
                    </div>
                </div>

                <!-- Record -->
                <div class="glass-card p-6 flex flex-col justify-between h-40 bg-zinc-800/80 border-zinc-600/30">
                     <div class="text-red-500 mb-2 animate-pulse">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" /></svg>
                     </div>
                    <div>
                        <!-- USER REQUEST: Add Braille translation -->
                        <h3 class="text-white font-semibold text-sm mb-1">Record <span class="text-xs font-mono ml-2 text-yellow-300 opacity-70">⠗⠑⠉⠕⠗⠙</span></h3>
                        <p class="text-zinc-400 text-xs leading-snug">Leave feedback or messages for the community.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 3: Universal Controls -->
    <section id="universal" class="content-section justify-end px-6 md:px-24">
        <div class="fade-in-section w-full max-w-sm text-right">
            <h2 class="section-title text-4xl font-bold mb-6 text-white">Universal Control.</h2>
            <div class="glass-card p-8 inline-block text-left w-full">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Tactile Dial</h3>
                        <p class="text-xs text-zinc-500 uppercase tracking-widest">Interface</p>
                    </div>
                </div>
                <p class="text-zinc-300 text-sm leading-relaxed">
                    A single, intuitive dial controls volume and playback using globally recognized symbols.
                    <span class="text-white block mt-2 font-medium">The central green light pulses to represent battery life and active device status.</span>
                </p>
            </div>
        </div>
    </section>

    <!-- Section 4: Maintenance (Clean Layout) -->
    <section id="specs" class="content-section min-h-screen flex flex-col justify-start items-center px-6 pt-32 relative">
        
        <!-- Maintenance Alert Style -->
        <div class="fade-in-section w-full max-w-3xl">
            <div class="glass-card p-1 flex items-center gap-4 bg-red-900/10 border-red-500/20">
                <div class="bg-red-500/10 p-4 h-full flex items-center rounded-l-[28px]">
                    <span class="text-red-500 font-bold text-xs uppercase tracking-wider rotate-180" style="writing-mode: vertical-rl;">Admin</span>
                </div>
                <div class="py-4 pr-6">
                    <h3 class="text-white font-bold text-lg">Maintenance Access</h3>
                    <p class="text-zinc-400 text-sm mt-1">
                        The <span class="text-red-400">Restart Button</span> is concealed on the bottom face, accessible only to City staff for secure resetting and diagnostics.
                    </p>
                </div>
            </div>
        </div>
        
        <footer class="absolute bottom-6 w-full text-center text-white/50 text-xs tracking-wider uppercase">
            Designed for Brantford &copy; 2025
        </footer>
    </section>

    <script>
    // Utility function to display temporary messages to the user
    function showMessage(text, duration = 3000) {
        const box = document.getElementById('message-box');
        if (!box) return;
        
        box.textContent = text;
        box.style.opacity = 1;
        
        // Hide after duration
        setTimeout(() => {
            box.style.opacity = 0;
        }, duration);
    }
    
    // AUDIO MANAGER (FIXED)
    const AudioManager = {
        sources: {
            // Background Jazz Music (Default) - Loop. Using known good CDN link.
            jazz: new Audio('https://cdn.jsdelivr.net/gh/brentd/static-files@main/audio/jazz.mp3'),
            // Pop Music (Music Button) - Loop. Using known good CDN link.
            pop: new Audio('https://cdn.jsdelivr.net/gh/brentd/static-files@main/audio/ambient.mp3'),
            // Recording Beep Sound Effect
            recordBeep: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
        },
        current: null,
        isRecording: false,
        recorder: null,
        stream: null,
        hasInteracted: false,

        init() {
            // Set loops and initial volume
            this.sources.jazz.loop = true;
            this.sources.pop.loop = true;
            this.sources.jazz.volume = 0.5;
            this.sources.pop.volume = 0.5;
            this.sources.recordBeep.volume = 0.7;
        },

        startBackground() {
            if(!this.hasInteracted) {
                this.hasInteracted = true;
                this.play('jazz');
                const overlay = document.getElementById('audio-start-overlay');
                if (overlay) overlay.style.opacity = 0;
            }
        },

        stopAll() {
            // Stop both music sources
            this.sources.jazz.pause();
            this.sources.pop.pause();
            // Cancel any ongoing TTS
            window.speechSynthesis.cancel();
            this.current = null;
        },

        play(type) {
            if(this.isRecording) return;
            
            // If the requested type is already playing (and it's not a short TTS/SFX), ignore the command
            if (this.current === type && (type === 'jazz' || type === 'pop')) {
                return;
            }

            this.stopAll();
            
            if (type === 'jazz') {
                this.sources.jazz.currentTime = 0; // Rewind to ensure it starts cleanly
                // Play is robust enough now, catches interaction error if necessary
                this.sources.jazz.play().catch(e => console.log("Audio play failed. Ensure interaction occurred.")); 
                this.current = 'jazz';
            } else if (type === 'pop') {
                this.sources.pop.currentTime = 0; // Rewind to start of song
                this.sources.pop.play().catch(e => console.log("Pop play failed."));
                this.current = 'pop';
            } else if (type === 'story') {
                const text = "Welcome to Brantford history. In 1874, Alexander Graham Bell invented the telephone right here. The Bell Homestead is a national historic site honoring this breakthrough.";
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; // Explicitly set language to English
                window.speechSynthesis.speak(u);
                this.current = 'story';
                u.onend = () => this.play('jazz'); 
            } else if (type === 'info') {
                const text = "Brantford City Update. Current temperature is 14 degrees Celsius. Road work on Colborne Street is expected to finish by Friday. Have a safe walk.";
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US'; // Explicitly set language to English
                window.speechSynthesis.speak(u);
                this.current = 'info';
                u.onend = () => this.play('jazz');
            }
        },

        async toggleRecord(onStart, onStop) {
            if (this.isRecording) {
                // STOP RECORDING
                if(this.recorder && this.recorder.state !== 'inactive') {
                    this.recorder.stop();
                }
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                this.isRecording = false;
                onStop(); // Callback for LED (turn off)
                this.play('jazz');
                console.log("Recording stopped. Jazz resumed.");
            } else {
                // START RECORDING
                this.stopAll();
                this.sources.recordBeep.currentTime = 0;
                this.sources.recordBeep.play(); // Play SFX before mic request

                try {
                    // Request microphone access
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(this.stream);
                    this.recorder.start();
                    this.isRecording = true;
                    onStart(); // Callback for LED (turn on)
                    console.log("Recording started. Waiting for second click to stop.");
                } catch (e) {
                    // Handle mic refusal/failure gracefully
                    onStop();
                    // Display user-friendly message
                    if (e.name === "NotAllowedError" || e.name === "Permission denied") {
                        showMessage("Recording failed: Microphone access was denied by the browser.", 4000);
                    } else {
                        showMessage("Recording failed due to a device error.", 4000);
                    }
                    console.error("Microphone access denied or failed. Resuming jazz.", e);
                    this.play('jazz');
                }
            }
        }
    };

    // WRAPPED IN IIFE
    (function() {
        AudioManager.init();

        // --- SCROLL OBSERVER FOR FADE IN EFFECTS ---
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in-section').forEach(section => {
            observer.observe(section);
        });

        // --- THREE.JS SCENE CONFIGURATION ---
        const container = document.getElementById('canvas-container');
        if(container.firstChild) container.removeChild(container.firstChild);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); 

        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 10); 
        
        const renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);
        
        // --- POST-PROCESSING ---
        let composer, bloomPass;
        function initPostProcessing() {
            if (typeof THREE.EffectComposer === 'undefined') return;
            
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));

            bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5, 0.3, 0.8
            );
            composer.addPass(bloomPass);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
        initPostProcessing();

        // --- INTERACTIVITY SETUP ---
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clickableObjects = [];
        let redDotLED = null;

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.15);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(5, 5, 10);
        mainLight.castShadow = true;
        mainLight.shadow.bias = -0.0001;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        scene.add(mainLight);

        const topLight = new THREE.SpotLight(0xffffff, 3.0);
        topLight.position.set(0, 10, 0);
        topLight.lookAt(0,0,0);
        scene.add(topLight);

        const fillLight = new THREE.PointLight(0xffaa00, 0.4);
        fillLight.position.set(-5, 0, 5);
        scene.add(fillLight);

        // --- MATERIALS (UNCHANGED) ---
        const colorYellow = 0xFFB800; 
        const matBody = new THREE.MeshPhysicalMaterial({ color: colorYellow, roughness: 0.25, metalness: 0.05, clearcoat: 0.2, clearcoatRoughness: 0.1 });
        const matBlack = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8, metalness: 0.1 });
        const colorGreen = 0x00A060; 
        const matCyan = new THREE.MeshPhysicalMaterial({ color: colorGreen, roughness: 0.3, metalness: 0.0, emissive: colorGreen, emissiveIntensity: 3.0 });
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.35, metalness: 0.9 });
        const matRedLED = new THREE.MeshStandardMaterial({ color: 0xFF0000, roughness: 0.1, metalness: 0.0, emissive: 0xFF0000, emissiveIntensity: 8.0 });
        const matBlackDot = new THREE.MeshStandardMaterial({ color: 0x010101, roughness: 0.9, metalness: 0.1, emissive: 0x000000 });
        const matGrayPress = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.8, metalness: 0.1 });

        // --- GEOMETRY HELPERS ---
        function createRoundedRect(w, h, r) {
            const shape = new THREE.Shape();
            shape.moveTo(-w/2 + r, h/2);
            shape.lineTo(w/2 - r, h/2);
            shape.quadraticCurveTo(w/2, h/2, w/2, h/2 - r);
            shape.lineTo(w/2, -h/2 + r);
            shape.quadraticCurveTo(w/2, -h/2, w/2 - r, -h/2);
            shape.lineTo(-w/2 + r, -h/2);
            shape.quadraticCurveTo(-w/2, -h/2, -w/2, -h/2 + r);
            shape.lineTo(-w/2, h/2 - r);
            shape.quadraticCurveTo(-w/2, h/2, -w/2 + r, h/2);
            return shape;
        }

        // --- BUILD DEVICE ---
        const deviceGroup = new THREE.Group();

        // Chassis
        const chassisShape = createRoundedRect(5.75, 2.2, 0.55);
        const chassisGeo = new THREE.ExtrudeGeometry(chassisShape, { depth: 0.6, bevelEnabled: true, bevelThickness: 0.08, bevelSize: 0.08, bevelSegments: 6 });
        chassisGeo.center();
        const chassis = new THREE.Mesh(chassisGeo, matBody);
        deviceGroup.add(chassis);
        const Z_SURFACE = 0.38; 

        // Left Dial (Universal Controls)
        const dialGroup = new THREE.Group();
        dialGroup.position.set(-1.75, 0, Z_SURFACE);
        
        const rimGroup = new THREE.Group();
        rimGroup.name = 'VOLUME_DIAL_RIM'; 
        rimGroup.userData.originalMat = matBlack;
        dialGroup.add(rimGroup);
        clickableObjects.push(rimGroup);

        const dishGeo = new THREE.CylinderGeometry(0.9, 1.0, 0.15, 64);
        const dish = new THREE.Mesh(dishGeo, matBlack);
        dish.rotation.x = Math.PI/2;
        dish.position.z = -0.05;
        rimGroup.add(dish);

        const slopeGeo = new THREE.CylinderGeometry(0.56, 0.9, 0.2, 64, 1, true);
        const slope = new THREE.Mesh(slopeGeo, matBlack);
        slope.rotation.x = Math.PI/2;
        slope.position.z = 0.0;
        rimGroup.add(slope);

        const btnGeo = new THREE.CylinderGeometry(0.54, 0.54, 0.1, 64);
        const btn = new THREE.Mesh(btnGeo, matCyan);
        btn.rotation.x = Math.PI/2;
        btn.position.z = 0.02;
        btn.name = 'PLAY_PAUSE_BUTTON'; 
        btn.userData.originalMat = matCyan;
        dialGroup.add(btn); 
        clickableObjects.push(btn);
        deviceGroup.add(dialGroup);

        // Center Speaker
        const cvs = document.createElement('canvas');
        cvs.width = 256; cvs.height = 512;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#000000';
        const gridY = 20; const radius = 7; const padX = 10; const padY = 10;
        const stepY = (cvs.height - padY*2) / gridY;
        const baseStepX = (cvs.width - padX*2) / 9;
        for(let y=0; y<=gridY; y++) {
            const numDots = (y % 2 === 0) ? 9 : 10; 
            const rowWidth = baseStepX * (numDots - 1);
            const centeringOffset = ((cvs.width - padX*2) - rowWidth) / 2;
            for(let x=0; x<numDots; x++) {
                ctx.beginPath();
                ctx.arc(padX + centeringOffset + x * baseStepX, padY + y*stepY, radius, 0, Math.PI*2);
                ctx.fill();
            }
        }
        const spkTex = new THREE.CanvasTexture(cvs);
        const spkPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.0, 1.8), new THREE.MeshPhysicalMaterial({ map: spkTex, color: 0x000000, roughness: 0.4, transparent: true, alphaTest: 0.1 }));
        spkPlane.position.set(-0.21, 0, Z_SURFACE + 0.01); 
        deviceGroup.add(spkPlane);

        // Right Button Cluster (Functional Keys)
        const padGroup = new THREE.Group();
        padGroup.position.set(1.55, 0, Z_SURFACE); 
        const hsShape = createRoundedRect(2.24, 1.74, 0.25);
        const hsGeo = new THREE.ExtrudeGeometry(hsShape, { depth: 0.05, bevelEnabled: false});
        hsGeo.center();
        const hs = new THREE.Mesh(hsGeo, matBlack);
        hs.position.z = 0.02;
        padGroup.add(hs);

        const btnShape = createRoundedRect(0.88, 0.66, 0.12);
        const btnGeom = new THREE.ExtrudeGeometry(btnShape, { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        btnGeom.center();
        
        const gapX = (2.24 - 2 * 0.88) / 3;
        const gapY = (1.74 - 2 * 0.66) / 3;
        const X_OFFSET = (0.88 / 2) + (gapX / 2);
        const Y_OFFSET = (0.66 / 2) + (gapY / 2);
        
        const positions = [
            { x: -X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'MUSIC_BUTTON' },
            { x: X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'STORY_BUTTON' },
            { x: -X_OFFSET, y: -Y_OFFSET, mat: matBlack, name: 'CITY_INFO_BUTTON' },
            { x: X_OFFSET, y: -Y_OFFSET, mat: matSteel, name: 'RECORD_BUTTON' }
        ];

        positions.forEach((p) => {
            const b = new THREE.Mesh(btnGeom, p.mat);
            b.position.set(p.x, p.y, 0.04);
            b.name = p.name;
            b.userData.originalMat = p.mat;
            if(p.name === 'RECORD_BUTTON') {
                const dot = new THREE.Mesh(new THREE.CircleGeometry(0.04, 16), matBlackDot);
                dot.position.set(0.88/3, -0.66/3, 0.04);
                b.add(dot);
                redDotLED = dot;
            }
            padGroup.add(b);
            clickableObjects.push(b);
        });
        deviceGroup.add(padGroup);
        
        // Restart Button (Bottom Face)
        const bottomBtnShape = createRoundedRect(1.0, 0.2, 0.08);
        const bottomBtnGeo = new THREE.ExtrudeGeometry(bottomBtnShape, { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        bottomBtnGeo.center();
        const bottomButton = new THREE.Mesh(bottomBtnGeo, matBlack);
        bottomButton.rotation.x = THREE.MathUtils.degToRad(-90);
        bottomButton.position.set(0, -1.1, 0.3 - 0.1);
        bottomButton.name = 'RESTART_BUTTON';
        bottomButton.userData.originalMat = matBlack;
        chassis.add(bottomButton);
        clickableObjects.push(bottomButton);

        scene.add(deviceGroup);

        // --- INTERACTION LOGIC ---
        function onPointerDown(event) {
            // CRITICAL: Start background audio on first interaction
            AudioManager.startBackground();

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);

            if (intersects.length > 0) {
                let interactiveElement = intersects[0].object;
                if (interactiveElement.parent && interactiveElement.parent.name === 'VOLUME_DIAL_RIM') {
                    interactiveElement = interactiveElement.parent;
                } else if (interactiveElement.name === 'MUSIC_BUTTON' || interactiveElement.name === 'STORY_BUTTON' || interactiveElement.name === 'CITY_INFO_BUTTON' || interactiveElement.name === 'RECORD_BUTTON') {
                    // Use the mesh itself
                } else if (interactiveElement.name !== 'PLAY_PAUSE_BUTTON' && interactiveElement.name !== 'RESTART_BUTTON') {
                    // Check if a child of a clickable object was hit (e.g., a detail inside a dial component)
                    let parent = intersects[0].object.parent;
                    while (parent) {
                        if (parent.name && clickableObjects.some(obj => obj.uuid === parent.uuid)) {
                            interactiveElement = parent;
                            break;
                        }
                        parent = parent.parent;
                    }
                }
                
                const originalZ = interactiveElement.position.z;
                const originalY = interactiveElement.position.y;
                const originalScale = interactiveElement.scale.clone();
                let momentaryMaterial = matGrayPress;

                // 1. Visual Press (Momentary)
                if (interactiveElement.name === 'VOLUME_DIAL_RIM') {
                    interactiveElement.children.forEach(child => child.material = momentaryMaterial);
                }
                
                // Apply momentary material to all functional buttons
                if (['MUSIC_BUTTON', 'STORY_BUTTON', 'CITY_INFO_BUTTON', 'RECORD_BUTTON'].includes(interactiveElement.name)) {
                    interactiveElement.material = momentaryMaterial;
                }

                if (interactiveElement.name === 'RESTART_BUTTON') interactiveElement.position.y += 0.01;
                else interactiveElement.position.z -= 0.01;
                interactiveElement.scale.set(0.98, 0.98, 0.98);

                // 2. Audio Logic
                if (interactiveElement.name === 'MUSIC_BUTTON') AudioManager.play('pop');
                else if (interactiveElement.name === 'STORY_BUTTON') AudioManager.play('story');
                else if (interactiveElement.name === 'CITY_INFO_BUTTON') AudioManager.play('info');
                else if (interactiveElement.name === 'RECORD_BUTTON') {
                    AudioManager.toggleRecord(
                        () => { 
                            // ON START: Red LED ON
                            redDotLED.material = matRedLED;
                            showMessage("Recording... Click again to stop.", 50000); 
                        }, 
                        () => { 
                            // ON STOP: Black LED OFF
                            redDotLED.material = matBlackDot; 
                        } 
                    );
                } 
                else if (interactiveElement.name === 'PLAY_PAUSE_BUTTON' || interactiveElement.name === 'VOLUME_DIAL_RIM') {
                    AudioManager.play('jazz');
                }
                else if (interactiveElement.name === 'RESTART_BUTTON') {
                    location.reload();
                }

                // 3. Release (Revert)
                setTimeout(() => {
                    if (interactiveElement.name === 'RESTART_BUTTON') interactiveElement.position.y = originalY;
                    else interactiveElement.position.z = originalZ;
                    interactiveElement.scale.copy(originalScale);
                    
                    // Revert Materials
                    if (interactiveElement.name === 'VOLUME_DIAL_RIM') {
                        interactiveElement.children.forEach(child => child.material = matBlack);
                    } else if (interactiveElement.name !== 'PLAY_PAUSE_BUTTON') {
                        interactiveElement.material = interactiveElement.userData.originalMat || matBlack;
                    }
                }, 150);
            }
        }
        container.addEventListener('pointerdown', onPointerDown, false);

        // --- SCROLL ANIMATION ---
        const targets = {
            'front': { cam: {x:0, y:-0.8, z:8.5}, rot: {x:0, y:0, z:0} },
            'functional': { cam: {x:0.5, y:0, z:5}, rot: {x:0, y:0.25, z:0} },
            'universal': { cam: {x:-0.5, y:0, z:5}, rot: {x:0, y:-0.25, z:0} },
            // Camera position raised for last phase, and rotated to show bottom face
            'specs': { cam: {x:0, y:0.8, z:7}, rot: {x:THREE.MathUtils.degToRad(-90), y:0, z:0} } 
        };
        let currentSection = 'front';

        function updateScroll() {
            const sections = ['front', 'functional', 'universal', 'specs'];
            let bestMatch = sections[0];
            let maxVis = 0;
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                if (visibleHeight > maxVis) { maxVis = visibleHeight; bestMatch = id; }
            });
            currentSection = bestMatch;
        }
        window.addEventListener('scroll', updateScroll);

        function animate() {
            requestAnimationFrame(animate);
            const tgt = targets[currentSection];
            if(tgt) {
                camera.position.x += (tgt.cam.x - camera.position.x) * 0.05;
                camera.position.y += (tgt.cam.y - camera.position.y) * 0.05;
                camera.position.z += (tgt.cam.z - camera.position.z) * 0.05;
                deviceGroup.rotation.x += (tgt.rot.x - deviceGroup.rotation.x) * 0.05;
                deviceGroup.rotation.y += (tgt.rot.y - deviceGroup.rotation.y) * 0.05;
                deviceGroup.rotation.z += (tgt.rot.z - deviceGroup.rotation.z) * 0.05;
            }
            deviceGroup.position.y = Math.sin(Date.now() * 0.001) * 0.05;

            // Battery Pulse Effect
            if (currentSection === 'universal') {
                const pulse = (Math.sin(Date.now() * 0.002) + 1) * 1.5 + 0.1; 
                matCyan.emissiveIntensity = pulse;
            } else {
                matCyan.emissiveIntensity += (3.0 - matCyan.emissiveIntensity) * 0.1;
            }

            if (composer) composer.render(); else renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (composer) composer.setSize(window.innerWidth, window.innerHeight);
        });

        const boundStartBackground = AudioManager.startBackground.bind(AudioManager);

        window.onload = () => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = 0;
                setTimeout(() => {
                    loader.style.display = 'none';
                    // Show audio overlay
                    const overlay = document.getElementById('audio-start-overlay');
                    if (overlay && !AudioManager.hasInteracted) {
                        overlay.style.opacity = 1;
                    }
                }, 500);
            }
            animate();
        };
        
        // Fix: Use the bound function to ensure 'this' refers to AudioManager
        document.addEventListener('click', boundStartBackground, { once: true });
        document.addEventListener('touchstart', boundStartBackground, { once: true });
    })();
    </script>
</body>
</html>

