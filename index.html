<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brantford Soundscape Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- POST-PROCESSING SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/shaders/LuminosityShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/LuminosityHighPassShader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <style>
        /* THEME CONFIGURATION */
        :root {
            /* Default to Night (Tech-Noir) */
            --color-surface: #000000;
            --color-accent: #FFD500;
            --color-text-primary: #ffffff;
            --color-text-secondary: #a1a1aa;
            
            --glass-bg: rgba(20, 20, 20, 0.4); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --glass-blur: 40px;
            --glass-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);

            --overlay-bg: rgba(0, 0, 0, 0.8);
            --section-bg: rgba(0, 0, 0, 0.8);
        }

        [data-theme="day"] {
            --color-surface: #e4e4e7; /* Zinc 200 */
            --color-accent: #d97706; /* Amber 600 */
            --color-text-primary: #18181b; /* Zinc 900 */
            --color-text-secondary: #52525b; /* Zinc 600 */
            
            --glass-bg: rgba(255, 255, 255, 0.6); 
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-highlight: rgba(255, 255, 255, 0.4);
            --glass-blur: 40px;
            --glass-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);

            --overlay-bg: rgba(228, 228, 231, 0.85);
            --section-bg: rgba(240, 240, 240, 0.85);
        }

        /* Prevent default window scroll to allow custom wrapper to handle snapping */
        html, body { 
            height: 100%;
            margin: 0;
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--color-surface); 
            color: var(--color-text-primary);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Dynamic Text Colors */
        .text-theme-primary { color: var(--color-text-primary); }
        .text-theme-secondary { color: var(--color-text-secondary); }
        .bg-theme-surface { background-color: var(--color-surface); }
        .section-bg-theme { background-color: var(--section-bg); }

        /* Tech-Noir Atmosphere Overlays - Adjust for Day */
        .atmosphere-vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
            background: radial-gradient(circle at center, transparent 40%, var(--color-surface) 120%);
            transition: background 0.5s ease;
        }

        .atmosphere-noise {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 4;
            opacity: 0.04;
            filter: url(#noiseFilter);
        }

        body.hide-ui > *:not(#canvas-container) {
            opacity: 0 !important;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; outline: none; pointer-events: auto; 
        }

        #main-scroll-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: scroll; overflow-x: hidden; scroll-behavior: smooth;
            scroll-snap-type: y mandatory; z-index: 10;
        }

        .content-section {
            position: relative; min-height: 100vh; display: flex; align-items: center; pointer-events: none; opacity: 0; transition: opacity 0.8s ease-in-out;
            scroll-snap-align: start; scroll-snap-stop: normal; 
        }
        
        .content-section.is-visible { opacity: 1; }
        #research.is-visible, #prototype.is-visible, #view360.is-visible { pointer-events: auto; }
        
        /* Glassmorphism */
        .glass-card {
            pointer-events: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 40px; 
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            transition: all 0.3s ease;
            box-shadow: var(--glass-shadow);
        }
        
        .glass-card:hover {
            border-color: var(--color-accent);
            transform: translateY(-2px);
        }

        .section-title {
            letter-spacing: -0.03em;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); 
            color: var(--color-text-primary);
        }

        .bento-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (max-width: 640px) { .bento-grid { grid-template-columns: 1fr; } }

        .scroll-indicator {
            position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%);
            animation: pulse 2s infinite; opacity: 0.5; color: var(--color-text-secondary);
        }
        @keyframes pulse {
            0% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
            50% { opacity: 0.7; transform: translateX(-50%) scale(1); }
            100% { opacity: 0.3; transform: translateX(-50%) scale(0.95); }
        }

        .loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000000; z-index: 9999;
            display: flex; justify-content: center; align-items: center; transition: opacity 0.5s;
        }

        /* Nav Island Styles */
        .nav-island {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
        }
        
        .nav-item {
            transition: all 0.3s ease; position: relative; white-space: nowrap; color: var(--color-text-secondary);
        }
        .nav-item:hover { color: var(--color-text-primary); }
        
        .nav-item.active {
            background-color: var(--color-accent);
            color: #000000 !important; /* Always black text on accent */
            box-shadow: 0 0 20px rgba(255, 213, 0, 0.2);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media (max-width: 768px) {
            .nav-brand-text { display: none; }
            .nav-divider { display: none; }
        }

        #audio-start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000;
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 1; transition: opacity 0.5s; pointer-events: auto; cursor: pointer;
        }
        #audio-start-overlay.hidden { opacity: 0; pointer-events: none; }

        /* Start Button */
        .start-button-pill {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 12px 32px;
            border-radius: 9999px;
            display: flex; align-items: center; gap: 12px; transition: all 0.3s ease;
        }
        .start-button-pill:hover {
            background: rgba(255, 255, 255, 0.1); transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 213, 0, 0.2); border-color: var(--color-accent);
        }
        .start-button-pill svg { color: var(--color-accent); animation: pulse-slow 2s infinite; }
        .start-btn-text {
            font-size: 14px; font-weight: 700; letter-spacing: 0.05em;
            color: var(--color-text-primary); text-transform: uppercase;
        }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        #message-box {
            position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 50px; border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight);
            color: var(--color-text-primary);
            z-index: 1000; opacity: 0; transition: opacity 0.5s, transform 0.5s; pointer-events: none;
            box-shadow: var(--glass-shadow); font-size: 14px; letter-spacing: 0.05em;
            width: auto; min-width: 200px; max-width: 80%; text-align: center;
        }

        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .btn-press { transform: scale(0.96); filter: brightness(1.3); transition: transform 0.05s, filter 0.05s; }
        .dial-segment { fill: #050505; stroke: #151515; stroke-width: 1px; transition: fill 0.1s; cursor: pointer; }
        .dial-segment:active { fill: #222; }
        .btn-housing { background-color: #050505; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }

        @media screen and (orientation: portrait) and (max-width: 768px) {
            .landscape-hint { display: flex !important; }
        }
        
        #progress-bar {
            width: 0%; height: 4px; background-color: var(--color-accent);
            position: fixed; bottom: 0; left: 0; z-index: 100;
            transition: width 0.1s linear; box-shadow: 0 0 10px rgba(255, 213, 0, 0.5);
        }
        
        #model-interaction-zone { touch-action: none; pointer-events: auto; }

        .bg-blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.3; z-index: 0; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(125, 125, 125, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(125, 125, 125, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(125, 125, 125, 0.5); }

    </style>
</head>
<body class="antialiased">

    <!-- Cinematic Noise SVG Filter -->
    <svg style="display: none;">
        <filter id="noiseFilter">
            <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/>
            <feColorMatrix type="saturate" values="0"/>
        </filter>
    </svg>
    <div class="atmosphere-noise"></div>
    <div class="atmosphere-vignette"></div>

    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-r-2 border-yellow-500 mb-4"></div>
            <p class="text-[10px] font-bold tracking-[0.3em] text-zinc-500 uppercase">Loading Experience</p>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div id="progress-bar"></div>

    <!-- START OVERLAY -->
    <div id="audio-start-overlay">
        <div class="start-button-pill">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <span class="start-btn-text">Start the Experience</span>
        </div>
    </div>

    <div id="message-box"></div>
    <div id="canvas-container"></div>

    <!-- Combined Nav Island (Floating Centered) -->
    <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 nav-island rounded-full p-2 pl-6 pr-2 flex items-center gap-4 max-w-[95vw] overflow-hidden">
        <!-- Integrated Branding -->
        <div class="nav-brand-text flex items-center gap-1 shrink-0">
            <span class="text-sm font-bold tracking-tighter text-theme-primary">BRANTFORD</span>
            <span class="text-yellow-500 font-bold">///</span>
            <span class="text-sm font-bold tracking-tighter text-theme-primary">SOUNDSCAPE</span>
        </div>
        
        <div class="nav-divider h-4 w-px bg-current opacity-20 shrink-0 text-theme-primary"></div>

        <!-- Navigation Links -->
        <div class="flex items-center gap-1 overflow-x-auto no-scrollbar">
            <a href="#front" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="front">MAIN</a>
            <a href="#functional" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="functional">FUNC</a>
            <a href="#universal" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="universal">CTRL</a>
            <a href="#specs" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="specs">SYSTM</a>
            <a href="#view360" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="view360">360°</a>
            <a href="#research" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="research">RSRCH</a>
            <a href="#prototype" class="nav-item px-4 py-2 rounded-full text-xs font-bold" data-target="prototype">DEMO</a>
        </div>

        <div class="nav-divider h-4 w-px bg-current opacity-20 shrink-0 text-theme-primary"></div>
        
        <!-- Theme Toggle Button -->
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 text-theme-secondary transition-colors" title="Toggle Day/Night Mode">
            <!-- Moon Icon (for Night) -->
            <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="block"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            <!-- Sun Icon (for Day - hidden by default) -->
            <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        </button>
    </nav>
    
    <!-- MAIN SCROLL CONTAINER -->
    <div id="main-scroll-container" class="no-scrollbar">
        <!-- 1. Main -->
        <section id="front" class="content-section justify-center text-center px-6">
            <div class="max-w-4xl mx-auto mt-[45vh]">
                <h1 class="section-title text-4xl md:text-8xl font-bold mb-6 leading-tight">
                    Public Atmosphere.<br>Reimagined.
                </h1>
                <p class="text-theme-secondary text-base md:text-xl max-w-2xl mx-auto leading-relaxed font-light">
                    An interactive audio experience designed to enhance community connection and deliver real-time information to Brantford.
                </p>
            </div>
            <div class="scroll-indicator text-xs font-medium tracking-widest uppercase">Scroll</div>
        </section>

        <!-- 2. Function -->
        <section id="functional" class="content-section justify-start px-6 md:px-24">
            <div class="w-full max-w-md">
                <h2 class="section-title text-3xl md:text-4xl font-bold mb-8">Core Functions.</h2>
                <div class="bento-grid">
                    <!-- Music -->
                    <div class="glass-card p-4 md:p-6 flex flex-col justify-between h-32 md:h-40">
                        <div class="text-yellow-500 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                        </div>
                        <div>
                            <h3 class="text-theme-primary font-semibold text-sm mb-1">Music</h3>
                            <p class="text-theme-secondary text-[10px] md:text-xs leading-snug">Curated, calming soundscapes.</p>
                        </div>
                    </div>
                    <!-- Story -->
                    <div class="glass-card p-4 md:p-6 flex flex-col justify-between h-32 md:h-40">
                          <div class="text-yellow-500 mb-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                          </div>
                        <div>
                            <h3 class="text-theme-primary font-semibold text-sm mb-1">Story</h3>
                            <p class="text-theme-secondary text-[10px] md:text-xs leading-snug">Local history and culture.</p>
                        </div>
                    </div>
                    <!-- City Info -->
                    <div class="glass-card p-4 md:p-6 flex flex-col justify-between h-32 md:h-40">
                          <div class="text-yellow-500 mb-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                          </div>
                        <div>
                            <h3 class="text-theme-primary font-semibold text-sm mb-1">City Info</h3>
                            <p class="text-theme-secondary text-[10px] md:text-xs leading-snug">Real-time updates.</p>
                        </div>
                    </div>
                    <!-- Record -->
                    <div class="glass-card p-4 md:p-6 flex flex-col justify-between h-32 md:h-40 bg-zinc-900/50 border-zinc-700/30">
                          <div class="text-red-500 mb-2 animate-pulse">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" /></svg>
                          </div>
                        <div>
                            <h3 class="text-white font-semibold text-sm mb-1">Record</h3>
                            <p class="text-secondary text-[10px] md:text-xs leading-snug">Leave community feedback.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Control -->
        <section id="universal" class="content-section justify-end px-6 md:px-24">
            <div class="w-full max-w-sm text-right">
                <h2 class="section-title text-3xl md:text-4xl font-bold mb-6">Universal Control.</h2>
                <div id="tactile-card" class="glass-card p-6 md:p-8 inline-block text-left w-full">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-theme-primary">Tactile Dial</h3>
                            <p class="text-xs text-theme-secondary uppercase tracking-widest">Interface</p>
                        </div>
                    </div>
                    <p class="text-theme-secondary text-sm leading-relaxed">
                        A single, intuitive dial controls volume and playback using globally recognized symbols.
                    </p>
                    <div id="universal-overlay" class="mt-8 transition-opacity duration-500">
                        <div id="overlay-controls-container" class="glass-card p-4 pointer-events-auto w-full mx-auto" style="border-radius: 30px; border: none; background: var(--glass-bg); backdrop-filter: blur(15px);">
                            <div id="overlay-controls" class="flex justify-around items-center space-x-2 text-theme-primary">
                                <button id="btn-vol-up" class="w-10 h-10 md:w-12 md:h-12 p-2 rounded-full hover:bg-white/20 transition duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg></button>
                                <button id="btn-prev" class="w-10 h-10 md:w-12 md:h-12 p-2 rounded-full hover:bg-white/20 transition duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg></button>
                                <button id="btn-play-pause-overlay" class="w-10 h-10 md:w-12 md:h-12 p-2 rounded-full hover:bg-white/20 transition duration-200"><svg id="play-pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500"><path d="M3 22v-20l18 10-18 10z"/></svg></button>
                                <button id="btn-next" class="w-10 h-10 md:w-12 md:h-12 p-2 rounded-full hover:bg-white/20 transition duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg></button>
                                <button id="btn-vol-down" class="w-10 h-10 md:w-12 md:h-12 p-2 rounded-full hover:bg-white/20 transition duration-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" x2="19" y1="12" y2="12"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Access (Specs) -->
        <section id="specs" class="content-section min-h-screen flex flex-col justify-start items-center px-6 pt-32 relative">
            <div class="w-full max-w-3xl">
                <div class="glass-card p-6 flex items-center gap-4 bg-red-900/10 border-red-500/20">
                    <div class="flex-grow">
                        <h3 class="text-white font-bold text-lg">Maintenance Access</h3>
                        <p class="text-secondary text-sm mt-1 mb-3">
                            The <span class="text-red-400">Restart Button</span> is concealed on the bottom face.
                        </p>
                        <a href="https://github.com/elias-dzobo/soundscape" target="_blank" class="inline-flex items-center gap-2 text-[10px] uppercase tracking-widest text-zinc-500 hover:text-white transition-colors border border-zinc-700/50 rounded-full px-3 py-1 bg-black/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                            System Source
                        </a>
                    </div>
                </div>
            </div>
            
            <div id="maintenance-overlay" class="absolute bottom-40 left-1/2 transform -translate-x-1/2 p-3 rounded-xl bg-red-900/10 border-red-500/20 transition-opacity duration-500 z-40 opacity-0 pointer-events-none">
                <button id="btn-restart-overlay" class="p-3 rounded-full bg-red-600 hover:bg-red-500 transition duration-200 text-white font-bold text-sm pointer-events-auto flex items-center gap-2" title="System Standby">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
                    RESTART
                </button>
            </div>

            <div class="scroll-indicator text-theme-secondary text-xs font-medium tracking-widest uppercase mt-8">Scroll for 360° View</div>
        </section>

        <!-- 5. 360 Degree View -->
        <section id="view360" class="content-section justify-center items-end px-6 pb-24 cursor-grab">
            <div id="model-interaction-zone" class="absolute top-0 left-0 w-full h-full z-20" style="background: transparent;"></div>
            
            <div class="absolute bottom-32 left-1/2 transform -translate-x-1/2 z-30 pointer-events-none nav-island rounded-full px-6 py-3 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.412 10.356A8.001 8.001 0 0120 11.5M4 15V9" /></svg>
                <span class="text-sm font-bold text-theme-primary uppercase tracking-wider">Drag to Rotate 360°</span>
            </div>

            <footer class="absolute bottom-2 translate-y-12 w-full text-center text-theme-secondary text-xs tracking-wider uppercase flex flex-col items-center gap-2 relative z-30">
                <span>Designed for Brantford &copy; 2025</span>
                <a href="https://github.com/elias-dzobo/soundscape" target="_blank" class="opacity-50 hover:opacity-100 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                </a>
            </footer>
        </section>

        <!-- 6. NEW: Research Process Section -->
        <section id="research" class="content-section flex flex-col justify-start pt-32 items-center px-6 min-h-screen section-bg-theme backdrop-blur-xl z-40 text-center relative w-full overflow-hidden">
            <!-- Background Orbs -->
            <div class="bg-blob w-96 h-96 bg-yellow-600/20 top-[-10%] left-[-10%]"></div>
            <div class="bg-blob w-80 h-80 bg-blue-600/10 bottom-[-10%] right-[-10%]"></div>

            <div class="w-full max-w-5xl h-[85vh] flex flex-col relative z-10">
                <!-- Header: Reverted to include Client/Timeline -->
                <div class="mb-8 text-center md:text-left pl-2">
                    <h2 class="text-3xl md:text-5xl font-bold text-theme-primary tracking-tight mb-2">Project Overview: Soundscape Brantford</h2>
                    <div class="flex flex-wrap gap-4 text-xs md:text-sm uppercase tracking-widest text-theme-secondary font-medium justify-center md:justify-start">
                        <span>Client: Workforce Planning Board of Grand Erie</span>
                        <span class="text-current opacity-20">|</span>
                        <span>Timeline: Oct 6 – Dec 4, 2025</span>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="glass-card p-8 md:p-12 overflow-y-auto custom-scrollbar space-y-12 text-left h-full">
                    
                    <!-- 1. Introduction -->
                    <div>
                        <h3 class="text-2xl font-bold text-theme-primary mb-4 border-l-4 border-yellow-500 pl-4">1. Introduction: The Sound of Safety</h3>
                        <p class="text-theme-secondary text-sm md:text-base leading-relaxed mb-4">
                            Downtown Brantford faces a unique challenge after dark: residents describe the environment as "airy, quiet, and empty," creating an unsettling atmosphere. While physical crime is a concern, our initial scoping revealed that the perception of safety is equally tied to emotional isolation.
                        </p>
                        <div class="grid md:grid-cols-2 gap-6 mt-6">
                            <div class="bg-theme-surface bg-opacity-20 p-6 rounded-2xl border border-white/5">
                                <h4 class="text-theme-primary font-bold text-sm uppercase tracking-wider mb-2">The Challenge</h4>
                                <p class="text-theme-secondary text-sm">How might we reimagine the downtown auditory experience to replace silence and fear with warmth and connection?</p>
                            </div>
                            <div class="bg-theme-surface bg-opacity-20 p-6 rounded-2xl border border-white/5">
                                <h4 class="text-yellow-500 font-bold text-sm uppercase tracking-wider mb-2">The Solution</h4>
                                <p class="text-theme-secondary text-sm">An inclusive, accessible, community-centered sound device that integrates ambient music, storytelling, and city information to foster a sense of "presence" without requiring visual surveillance.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Methodology -->
                    <div>
                        <h3 class="text-2xl font-bold text-theme-primary mb-6 border-l-4 border-yellow-500 pl-4">2. Research Methodology</h3>
                        <p class="text-theme-secondary text-sm mb-6">We utilized a mixed-method research framework to move beyond assumptions and understand the nuance of nighttime safety.</p>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-theme-primary font-bold text-lg mb-4">Preliminary Research</h4>
                                <ul class="space-y-4">
                                    <li class="flex gap-3">
                                        <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-2 shrink-0"></span>
                                        <span class="text-theme-secondary text-sm"><strong class="text-theme-primary">Unstructured Interviews:</strong> Engaged 5 participants (students, seniors).</span>
                                    </li>
                                    <li class="flex gap-3">
                                        <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-2 shrink-0"></span>
                                        <span class="text-theme-secondary text-sm"><strong class="text-theme-primary">Field Observations:</strong> Documented silent streets after 9PM.</span>
                                    </li>
                                    <li class="flex gap-3">
                                        <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-2 shrink-0"></span>
                                        <span class="text-theme-secondary text-sm"><strong class="text-theme-primary">Content Analysis:</strong> 67% of feedback cited lack of trust.</span>
                                    </li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="text-theme-primary font-bold text-lg mb-4">Iterative Testing</h4>
                                <ul class="space-y-4">
                                    <li class="flex gap-3">
                                        <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-2 shrink-0"></span>
                                        <span class="text-theme-secondary text-sm"><strong class="text-theme-primary">A/B Testing:</strong> Knobs vs. Buttons for intuition.</span>
                                    </li>
                                    <li class="flex gap-3">
                                        <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 mt-2 shrink-0"></span>
                                        <span class="text-theme-secondary text-sm"><strong class="text-theme-primary">Contextual Inquiry:</strong> Tested at Bus Terminal & One Market.</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Insights -->
                    <div>
                        <h3 class="text-2xl font-bold text-theme-primary mb-6 border-l-4 border-yellow-500 pl-4">3. Key Research Insights</h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="p-5 rounded-xl bg-gradient-to-br from-white/10 to-transparent border border-white/5">
                                <h4 class="text-yellow-500 font-bold mb-2">Silence is the Enemy</h4>
                                <p class="text-xs text-theme-secondary leading-relaxed">It wasn't just darkness, but silence that caused fear. Users desired the comfort of auditory "presence".</p>
                            </div>
                            <div class="p-5 rounded-xl bg-gradient-to-br from-white/10 to-transparent border border-white/5">
                                <h4 class="text-yellow-500 font-bold mb-2">The "No-Phone" Mandate</h4>
                                <p class="text-xs text-theme-secondary leading-relaxed">Users rejected apps/QR codes at night due to safety risks. The device must be standalone.</p>
                            </div>
                            <div class="p-5 rounded-xl bg-gradient-to-br from-white/10 to-transparent border border-white/5">
                                <h4 class="text-yellow-500 font-bold mb-2">Universal Accessibility</h4>
                                <p class="text-xs text-theme-secondary leading-relaxed">Standard symbols and tactile controls outperformed minimalist abstract designs.</p>
                            </div>
                            <div class="p-5 rounded-xl bg-gradient-to-br from-white/10 to-transparent border border-white/5">
                                <h4 class="text-yellow-500 font-bold mb-2">Demand for Utility</h4>
                                <p class="text-xs text-theme-secondary leading-relaxed">Users requested practical value like City Info and Recording features beyond just ambiance.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Evolution -->
                    <div class="pb-12">
                        <h3 class="text-2xl font-bold text-theme-primary mb-6 border-l-4 border-yellow-500 pl-4">4. From Research to Reality</h3>
                        <div class="space-y-6 border-l border-white/10 ml-2 pl-8 relative">
                            <div class="relative">
                                <span class="absolute -left-[37px] top-1 w-4 h-4 rounded-full bg-zinc-800 border border-zinc-600"></span>
                                <h4 class="text-theme-primary font-bold mb-1">Low-Fidelity</h4>
                                <p class="text-theme-secondary text-sm">Shifted from complex multifunction knobs to universally recognized buttons.</p>
                            </div>
                            <div class="relative">
                                <span class="absolute -left-[37px] top-1 w-4 h-4 rounded-full bg-zinc-800 border border-zinc-600"></span>
                                <h4 class="text-theme-primary font-bold mb-1">Mid-Fidelity</h4>
                                <p class="text-theme-secondary text-sm">Removed Bluetooth to ensure accessibility for unhoused individuals.</p>
                            </div>
                            <div class="relative">
                                <span class="absolute -left-[37px] top-1 w-4 h-4 rounded-full bg-yellow-500 shadow-[0_0_10px_rgba(255,213,0,0.5)]"></span>
                                <h4 class="text-theme-primary font-bold mb-1">High-Fidelity Outcome</h4>
                                <p class="text-theme-secondary text-sm">A weather-sealed, tactile, and intuitive public interface that transforms the "sound of silence" into a shared community experience.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- 7. Prototype Interaction Layer -->
        <!-- UPDATED: bg-black/95 to ensure 'fade from black' effect obscures the model more heavily -->
        <section id="prototype" class="content-section flex justify-center items-center overflow-hidden relative w-full min-h-screen section-bg-theme backdrop-blur-xl z-50">
            <div class="landscape-hint hidden absolute top-0 left-0 w-full h-full section-bg-theme z-[60] flex-col items-center justify-center text-center p-8 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-500 mb-4 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                <p class="text-theme-primary text-sm uppercase tracking-widest">Rotate for Better View</p>
            </div>

            <div class="absolute top-4 w-full text-center pointer-events-none">
                 <p class="text-theme-secondary text-[10px] md:text-xs uppercase tracking-[0.3em]">Interactive Mobile Prototype</p>
            </div>
            
            <!-- Physical Device Container -->
            <div id="interface-shell" class="relative bg-[#FFD500] rounded-[20px] md:rounded-[30px] shadow-2xl pointer-events-auto" style="aspect-ratio: 5.75/2.2; width: 98vw; max-width: 1000px; box-shadow: inset 0 0 60px rgba(255,255,255,0.15), 0 20px 50px rgba(0,0,0,0.5);">
                
                <!-- Left: Tactile Dial -->
                <div id="demo-dial-container" class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 aspect-square rounded-full flex items-center justify-center" style="left: 19.56%; width: 34.78%;">
                    <svg viewBox="0 0 100 100" class="absolute w-full h-full drop-shadow-xl">
                        <defs>
                            <filter id="inset-shadow">
                                <feOffset dx="0" dy="1" />
                                <feGaussianBlur stdDeviation="1" result="offset-blur" />
                                <feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse" />
                                <feFlood flood-color="black" flood-opacity="0.8" result="color" />
                                <feComposite operator="in" in="color" in2="inverse" result="shadow" />
                                <feComposite operator="over" in="shadow" in2="SourceGraphic" />
                            </filter>
                        </defs>

                        <!-- Top (Vol Up) -->
                        <path d="M 50 5 A 45 45 0 0 1 95 50 L 78 50 A 28 28 0 0 0 50 22 Z" transform="rotate(-45 50 50)" class="dial-segment" data-action="vol-up"></path>
                        <!-- Right (Next) -->
                        <path d="M 50 5 A 45 45 0 0 1 95 50 L 78 50 A 28 28 0 0 0 50 22 Z" transform="rotate(45 50 50)" class="dial-segment" data-action="next"></path>
                        <!-- Bottom (Vol Down) -->
                        <path d="M 50 5 A 45 45 0 0 1 95 50 L 78 50 A 28 28 0 0 0 50 22 Z" transform="rotate(135 50 50)" class="dial-segment" data-action="vol-down"></path>
                        <!-- Left (Prev) -->
                        <path d="M 50 5 A 45 45 0 0 1 95 50 L 78 50 A 28 28 0 0 0 50 22 Z" transform="rotate(225 50 50)" class="dial-segment" data-action="prev"></path>
                        
                        <text x="50" y="15" fill="#666" font-size="8" text-anchor="middle" font-weight="bold" pointer-events="none" style="filter: drop-shadow(0px 1px 0px rgba(0,0,0,0.5));">+</text>
                        <text x="50" y="88" fill="#666" font-size="10" text-anchor="middle" font-weight="bold" pointer-events="none" style="filter: drop-shadow(0px 1px 0px rgba(0,0,0,0.5));">-</text>
                        <text x="88" y="53" fill="#666" font-size="6" text-anchor="middle" pointer-events="none" style="filter: drop-shadow(0px 1px 0px rgba(0,0,0,0.5));">►►</text>
                        <text x="12" y="53" fill="#666" font-size="6" text-anchor="middle" pointer-events="none" style="filter: drop-shadow(0px 1px 0px rgba(0,0,0,0.5));">◄◄</text>
                    </svg>

                    <!-- Center Button -->
                    <button id="demo-play-btn" class="relative w-[54%] h-[54%] rounded-full bg-[#00A060] flex items-center justify-center shadow-[inset_0_2px_5px_rgba(255,255,255,0.2),0_5px_10px_rgba(0,0,0,0.3)] active:scale-95 transition-transform z-10" data-action="play">
                         <svg id="demo-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-black drop-shadow-sm" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                </div>

                <!-- Middle: Speaker Grille -->
                <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 flex flex-col items-center justify-center" style="left: 46.34%; width: 17.39%; height: 81.8%;">
                    <script>
                        const container = document.currentScript.parentNode;
                        for(let i=0; i<20; i++) {
                            const row = document.createElement('div');
                            row.className = "flex justify-center gap-[5px] mb-[5px] w-full";
                            const count = (i % 2 === 0) ? 9 : 10;
                            for(let j=0; j<count; j++) {
                                const dot = document.createElement('div');
                                dot.className = "w-2.5 h-2.5 bg-[#050505] rounded-full shadow-inner";
                                row.appendChild(dot);
                            }
                            container.appendChild(row);
                        }
                    </script>
                </div>

                <!-- Right: Function Buttons -->
                <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 btn-housing" style="left: 76.95%; width: 38.96%; height: 79.09%;">
                    <div class="w-full h-full grid grid-cols-2 grid-rows-2" style="padding: 8% 7.1%; gap: 8% 7.1%;">
                        
                        <button class="bg-[#111] rounded-xl shadow-[0_2px_4px_rgba(0,0,0,0.8),_inset_0_1px_1px_rgba(255,255,255,0.15)] flex flex-col items-center justify-center text-zinc-400 active:bg-black active:shadow-inner transition-all border-t border-white/10" data-action="music">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                            <span class="text-[9px] uppercase font-bold tracking-widest text-zinc-500">Music</span>
                        </button>
                        
                        <button class="bg-[#111] rounded-xl shadow-[0_2px_4px_rgba(0,0,0,0.8),_inset_0_1px_1px_rgba(255,255,255,0.15)] flex flex-col items-center justify-center text-zinc-400 active:bg-black active:shadow-inner transition-all border-t border-white/10" data-action="story">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                            <span class="text-[9px] uppercase font-bold tracking-widest text-zinc-500">Story</span>
                        </button>
                        
                        <button class="bg-[#111] rounded-xl shadow-[0_2px_4px_rgba(0,0,0,0.8),_inset_0_1px_1px_rgba(255,255,255,0.15)] flex flex-col items-center justify-center text-zinc-400 active:bg-black active:shadow-inner transition-all border-t border-white/10" data-action="info">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span class="text-[9px] uppercase font-bold tracking-widest text-zinc-500">Info</span>
                        </button>
                        
                        <button class="bg-gradient-to-br from-[#d4d4d4] via-[#999] to-[#666] rounded-xl shadow-[0_2px_4px_rgba(0,0,0,0.8),_inset_0_1px_1px_rgba(255,255,255,0.6)] flex flex-col items-center justify-center text-zinc-800 active:scale-95 transition-all relative border border-white/20" data-action="record">
                            <div id="demo-rec-led" class="absolute w-1.5 h-1.5 rounded-full bg-[#111] shadow-[inset_0_1px_2px_rgba(0,0,0,0.8),0_1px_0_rgba(255,255,255,0.5)] border border-black/20 transition-colors duration-200" style="right: 16%; bottom: 18%;"></div>
                            <span class="text-[9px] uppercase font-bold tracking-widest text-zinc-900 drop-shadow-sm">Record</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
    function showMessage(text, duration = 3000) {
        const box = document.getElementById('message-box');
        if (!box) return;
        box.textContent = text;
        box.style.opacity = 1;
        setTimeout(() => { box.style.opacity = 0; }, duration);
    }
    
    let isPlaying = true; 
    let playPauseIcon = null;

    function updatePlayPauseIcon(playing) {
        const path = playing ? `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : `<path d="M3 22v-20l18 10-18 10z"/>`;
        if (playPauseIcon) playPauseIcon.innerHTML = path;
        const demoIcon = document.getElementById('demo-play-icon');
        if (demoIcon) demoIcon.innerHTML = path;
    }

    const AudioManager = {
        trackList: ['jazz-background-music-333352.mp3', 'jazz-background-music-338663.mp3', 'jazz-background-music-379027.mp3', 'jazz-background-music-426859.mp3'],
        currentTrackIndex: 0, audioElement: null,
        sources: { recordBeep: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg') },
        current: null, isRecording: false, recorder: null, stream: null, hasInteracted: false,
        voices: [],
        storyContent: [
            "Brantford is proudly known worldwide as the Telephone City. It was here, at his family's homestead—Melville House—on a humid summer day in 1874, that Alexander Graham Bell first conceived the revolutionary idea of the telephone. Just two years later, he proved his invention worked by successfully receiving a clear long-distance transmission from Paris, Ontario, forever changing how humanity connects.",
            "Art lovers know Brantford as the birthplace of Lawren Harris, a founder of the iconic Group of Seven. Born here in 1885, his childhood home still stands on West Colborne Street. The wealthy industrial atmosphere of turn-of-the-century Brantford provided the backdrop for his early life before he ventured north to paint the stark, spiritual landscapes that defined Canadian art.",
            "Her Majesty's Royal Chapel of the Mohawks is a site of profound significance. Built in 1785, it is the oldest surviving church in Ontario and the first Protestant church in Upper Canada. It was given to the Mohawk people led by Joseph Brant as a reminder of the alliances formed during the American Revolution, and it remains a designated National Historic Site today.",
            "For hockey fans, Brantford is hallowed ground. This is the hometown of Wayne Gretzky, the Great One. Visitors often flock to the Wayne Gretzky Sports Centre, not just to skate, but to see the inspiring 12-foot bronze statue of Wayne hoisting the Stanley Cup, with statues of his parents, Walter and Phyllis, standing proudly nearby.",
            "In the late 19th century, Brantford was an industrial titan, ranking third in all of Canada for export value. Factories here produced everything from Massey-Harris farm equipment to biscuits and textiles, shipping goods across the British Empire. That blue-collar grit and innovation laid the foundation for the resilient community we see today.",
            "The Grand River, a designated Canadian Heritage River, is the lifeblood of our landscape. It winds through the city offering some of the best fly-fishing for steelhead trout in the province. The extensive trail system along its banks allows residents to walk, cycle, and find a moment of peace right in the heart of the city."
        ],
        getCityInfo() {
            const time = new Date();
            const hour = time.getHours();
            const minutes = time.getMinutes();
            const timeString = `${hour % 12 || 12}:${minutes < 10 ? '0' + minutes : minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
            let greeting = "Good morning";
            if(hour >= 12 && hour < 17) greeting = "Good afternoon";
            else if(hour >= 17) greeting = "Good evening";
            const weather = [
                "skies are currently clear with a pleasant temperature of 22 degrees",
                "we are seeing some overcast clouds with a chance of light rain later this evening",
                "it is a sunny and bright day, perfect for outdoor activities",
                "winds are picking up slightly from the west, bringing cooler temperatures"
            ];
            const selectedWeather = weather[Math.floor(Math.random() * weather.length)];
            const news = [
                "In traffic news, construction on King George Road is causing minor delays, so please plan your route accordingly.",
                "Community reminder: The Brantford Public Library is hosting a local author reading series tonight at 7 PM.",
                "If you are heading downtown, the Market Centre Parkade has ample parking available right now.",
                "Don't forget, waste collection for Ward 3 is scheduled for tomorrow morning. Please have your bins out by 7 AM.",
                "Transit update: Route 8 Holmedale is currently running five minutes behind schedule."
            ];
            const selectedNews = news[Math.floor(Math.random() * news.length)];
            return `${greeting}, Brantford. It is currently ${timeString}. The ${selectedWeather}. ${selectedNews}. Stay safe and enjoy your day.`;
        },
        init() {
            this.audioElement = new Audio();
            this.audioElement.loop = false; 
            this.audioElement.volume = 0.5;
            this.sources.recordBeep.volume = 0.7;
            this.loadTrack(this.currentTrackIndex);
            this.audioElement.addEventListener('ended', () => { if (this.current === 'music' && isPlaying) this.playNextTrack(); });
            const loadVoices = () => { this.voices = window.speechSynthesis.getVoices(); };
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) { window.speechSynthesis.onvoiceschanged = loadVoices; }
        },
        loadTrack(index) {
            this.currentTrackIndex = (index % this.trackList.length + this.trackList.length) % this.trackList.length;
            this.audioElement.src = this.trackList[this.currentTrackIndex];
            this.audioElement.load();
            if (isPlaying && this.hasInteracted) this.audioElement.play().catch(e => console.log("Resume failed"));
        },
        playNextTrack() { this.loadTrack(this.currentTrackIndex + 1); showMessage(`Next Track: ${this.currentTrackIndex + 1}`, 2000); },
        playPrevTrack() { this.loadTrack(this.currentTrackIndex - 1); showMessage(`Prev Track: ${this.currentTrackIndex + 1}`, 2000); },
        volumeUp() { this.audioElement.volume = Math.min(1.0, this.audioElement.volume + 0.1); showMessage(`Vol: ${Math.round(this.audioElement.volume * 100)}%`, 1000); },
        volumeDown() { this.audioElement.volume = Math.max(0.0, this.audioElement.volume - 0.1); showMessage(`Vol: ${Math.round(this.audioElement.volume * 100)}%`, 1000); },
        startBackground() { if(!this.hasInteracted) { this.hasInteracted = true; hideInitialOverlay(); this.play('music'); } },
        stopBackgroundMusic() { this.audioElement.pause(); isPlaying = false; updatePlayPauseIcon(false); },
        stopAll() { this.audioElement.pause(); window.speechSynthesis.cancel(); this.current = null; isPlaying = false; updatePlayPauseIcon(false); },
        play(type) {
            if(this.isRecording) return;
            if (type === 'music') {
                 if (this.current === 'music' && !this.audioElement.paused) return; 
                 if (this.current === 'story' || this.current === 'info') window.speechSynthesis.cancel();
                 this.audioElement.currentTime = 0; 
                 this.audioElement.play().catch(e => showMessage("Audio restricted. Interact first.", 3000)); 
                 this.current = 'music'; isPlaying = true; updatePlayPauseIcon(true); return;
            }
            this.stopAll();
            if (type === 'story' || type === 'info') {
                let text = "";
                if (type === 'story') { text = this.storyContent[Math.floor(Math.random() * this.storyContent.length)]; showMessage("Playing Local History...", 3000); } 
                else { text = this.getCityInfo(); showMessage("Broadcasting City Info...", 3000); }
                const u = new SpeechSynthesisUtterance(text);
                if (this.voices.length > 0) {
                    const preferredVoice = this.voices.find(v => v.name.includes('Google US English')) || this.voices.find(v => v.name.includes('Google UK English Female')) || this.voices.find(v => v.name.includes('Natural')) || this.voices.find(v => v.name.includes('en-US'));
                    if (preferredVoice) { u.voice = preferredVoice; }
                }
                u.rate = 0.9; u.pitch = 1.0;
                window.speechSynthesis.speak(u); this.current = type; u.onend = () => this.play('music'); 
            }
        },
        async toggleRecord(onStart, onStop) {
            if (this.isRecording) {
                if(this.recorder && this.recorder.state !== 'inactive') this.recorder.stop();
                if (this.stream) this.stream.getTracks().forEach(track => track.stop());
                this.isRecording = false; onStop(); this.play('music');
            } else {
                this.stopAll(); this.sources.recordBeep.currentTime = 0; this.sources.recordBeep.play();
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(this.stream);
                    this.recorder.start();
                    this.isRecording = true; onStart();
                } catch (e) { onStop(); showMessage("Microphone access denied.", 4000); this.play('music'); }
            }
        }
    };

    function toggleAudioPlayback() {
        if (isPlaying) { AudioManager.stopBackgroundMusic(); isPlaying = false; showMessage("Paused", 1000); }
        else { AudioManager.play('music'); isPlaying = true; showMessage("Resumed", 1000); }
    }
    
    function hideInitialOverlay() {
        const overlay = document.getElementById('audio-start-overlay');
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('noscroll');
    }

    function triggerPixelTransition(onComplete) {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.zIndex = '10000';
        overlay.style.display = 'grid';
        
        // Updated density: 24 cols (Original 12 x 2)
        const cols = 24; 
        const rows = Math.ceil(cols * (window.innerHeight / window.innerWidth));
        overlay.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        overlay.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        
        document.body.appendChild(overlay);

        const blocks = [];
        for (let i = 0; i < cols * rows; i++) {
            const block = document.createElement('div');
            // Updated Visuals: Solid Black
            block.style.backgroundColor = '#000000'; 
            
            block.style.width = '100%';
            block.style.height = '100%';
            block.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            overlay.appendChild(block);
            blocks.push(block);
        }

        // Force reflow
        overlay.offsetHeight;

        // Start animation
        document.getElementById('audio-start-overlay').style.display = 'none';
        document.body.classList.remove('noscroll');

        // Animation Loop: Top-to-Bottom flow
        blocks.forEach((block, index) => {
            setTimeout(() => {
                block.style.transform = 'scale(0)';
                block.style.opacity = '0';
            }, index * 2.5); // Slower pacing
        });

        // Cleanup
        setTimeout(() => {
            overlay.remove();
            if(onComplete) onComplete();
        }, (blocks.length * 2.5) + 600);
    }

    // THEME TOGGLING LOGIC
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'night' ? 'day' : 'night';
        html.setAttribute('data-theme', newTheme);
        
        // Toggle Icons
        document.getElementById('icon-moon').classList.toggle('hidden');
        document.getElementById('icon-sun').classList.toggle('hidden');
        
        // Update Three.js Scene
        updateSceneTheme(newTheme === 'day');
    }
    
    // Exposed for Three.js to access later
    let updateSceneTheme = (isDay) => {}; 

    (function() {
        // Theme init
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        AudioManager.init();
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { entry.target.classList.toggle('is-visible', entry.isIntersecting); });
        }, { threshold: 0.1 });
        document.querySelectorAll('.content-section').forEach(section => observer.observe(section));

        const demoContainer = document.getElementById('prototype');
        if (demoContainer) {
            demoContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;
                AudioManager.startBackground();
                const action = btn.dataset.action;
                if(btn.tagName !== 'path') { btn.classList.add('btn-press'); setTimeout(() => btn.classList.remove('btn-press'), 150); }
                if (action === 'play') toggleAudioPlayback();
                else if (action === 'vol-up') AudioManager.volumeUp();
                else if (action === 'vol-down') AudioManager.volumeDown();
                else if (action === 'next') AudioManager.playNextTrack();
                else if (action === 'prev') AudioManager.playPrevTrack();
                else if (['music', 'story', 'info'].includes(action)) AudioManager.play(action);
                else if (action === 'record') {
                    const led = document.getElementById('demo-rec-led');
                    AudioManager.toggleRecord(() => { if(led) led.style.backgroundColor = 'red'; showMessage("Recording...", 50000); }, () => { if(led) led.style.backgroundColor = '#111'; });
                }
            });
        }

        const container = document.getElementById('canvas-container');
        if(container.firstChild) container.removeChild(container.firstChild);
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); 
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 10); 
        const renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);
        
        let composer, bloomPass;
        function initPostProcessing() {
            if (typeof THREE.EffectComposer === 'undefined') return;
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));
            bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.3, 0.8);
            composer.addPass(bloomPass);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
        initPostProcessing();

        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clickableObjects = [];
        let redDotLED = null;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let manualRotation = { x: 0, y: 0 };

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.05); scene.add(ambientLight);
        const spotLight1 = new THREE.SpotLight(0xffffff, 2.0); spotLight1.position.set(5, 10, 5); spotLight1.angle = Math.PI / 6; spotLight1.penumbra = 0.5; spotLight1.castShadow = true; scene.add(spotLight1);
        const spotLight2 = new THREE.SpotLight(0xffffff, 1.5); spotLight2.position.set(-5, 5, -5); spotLight2.angle = Math.PI / 4; spotLight2.penumbra = 1.0; scene.add(spotLight2);
        const fillLight = new THREE.PointLight(0xffaa00, 0.2); fillLight.position.set(-5, 0, 5); scene.add(fillLight);
        const bottomLight = new THREE.PointLight(0x444444, 1.0); bottomLight.position.set(0, -10, 0); scene.add(bottomLight);

        // Define update function for theme toggle
        updateSceneTheme = (isDay) => {
            if (isDay) {
                scene.background = new THREE.Color(0xe4e4e7); // Zinc 200
                // Brighter ambient for day
                ambientLight.intensity = 0.8;
                // Soften spotlights for day
                spotLight1.intensity = 1.2;
                spotLight2.intensity = 0.8;
                fillLight.intensity = 0.5;
                bottomLight.intensity = 0.5;
            } else {
                scene.background = new THREE.Color(0x000000); // Night
                ambientLight.intensity = 0.05;
                spotLight1.intensity = 2.0;
                spotLight2.intensity = 1.5;
                fillLight.intensity = 0.2;
                bottomLight.intensity = 1.0;
            }
        };

        const colorYellow = 0xFFA000; 
        const matBody = new THREE.MeshPhysicalMaterial({ color: colorYellow, roughness: 0.2, metalness: 0.1, clearcoat: 0.5 });
        const matBlack = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 1.0, metalness: 0.0 });
        const matSafetyGreen = new THREE.MeshPhysicalMaterial({ color: 0x39FF14, roughness: 0.2, metalness: 0.0, emissive: 0x114411, emissiveIntensity: 0.2, clearcoat: 0.3 });
        const matSteel = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.35, metalness: 0.9 });
        const matRedLED = new THREE.MeshStandardMaterial({ color: 0xFF0000, roughness: 0.5, metalness: 0.0 });
        const matBlackDot = new THREE.MeshStandardMaterial({ color: 0x010101, roughness: 1.0, metalness: 0.0, emissive: 0x000000 });
        const matGrayPress = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.8, metalness: 0.1 });

        function createRoundedRect(w, h, r) {
            const shape = new THREE.Shape();
            shape.moveTo(-w/2 + r, h/2); shape.lineTo(w/2 - r, h/2); shape.quadraticCurveTo(w/2, h/2, w/2, h/2 - r);
            shape.lineTo(w/2, -h/2 + r); shape.quadraticCurveTo(w/2, -h/2, w/2 - r, -h/2); shape.lineTo(-w/2 + r, -h/2);
            shape.quadraticCurveTo(-w/2, -h/2, -w/2, -h/2 + r); shape.lineTo(-w/2, h/2 - r); shape.quadraticCurveTo(-w/2, h/2, -w/2 + r, h/2);
            return shape;
        }

        const deviceGroup = new THREE.Group();
        const chassis = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(5.75, 2.2, 0.55), { depth: 0.6, bevelEnabled: true, bevelThickness: 0.08, bevelSize: 0.08, bevelSegments: 6 }), matBody);
        chassis.geometry.center(); deviceGroup.add(chassis);
        const Z_SURFACE = 0.38; 

        const dialGroup = new THREE.Group(); dialGroup.position.set(-1.75, 0, Z_SURFACE);
        const segs = 4; const gap = 0.007; const arc = (Math.PI * 2) / segs - gap;
        const rimGroup = new THREE.Group(); rimGroup.name = 'VOLUME_DIAL_RIM'; rimGroup.userData.originalMat = matBlack; dialGroup.add(rimGroup); clickableObjects.push(rimGroup);
        for(let i=0; i<segs; i++) {
            const centerAngle = i * (Math.PI/2); const startAngle = centerAngle - arc/2;
            const dish = new THREE.Mesh(new THREE.CylinderGeometry(0.9, 1.0, 0.15, 32, 1, false, startAngle, arc), matBlack);
            dish.rotation.x = Math.PI/2; dish.position.z = -0.05; dish.userData.quadrant = i; rimGroup.add(dish);
            const slope = new THREE.Mesh(new THREE.CylinderGeometry(0.56, 0.9, 0.2, 32, 1, true, startAngle, arc), matBlack);
            slope.rotation.x = Math.PI/2; slope.position.z = 0.0; slope.userData.quadrant = i; rimGroup.add(slope);
        }
        const btn = new THREE.Mesh(new THREE.CylinderGeometry(0.54, 0.54, 0.1, 64), matSafetyGreen); 
        btn.rotation.x = Math.PI/2; btn.position.z = 0.02; btn.name = 'PLAY_PAUSE_BUTTON'; btn.userData.originalMat = matSafetyGreen;
        dialGroup.add(btn); clickableObjects.push(btn); deviceGroup.add(dialGroup);

        const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 512; const ctx = cvs.getContext('2d'); ctx.fillStyle = '#000000';
        const gridY = 20; const radius = 7; const padX = 10; const padY = 10; const stepY = (cvs.height - padY*2) / gridY; const baseStepX = (cvs.width - padX*2) / 9;
        for(let y=0; y<=gridY; y++) {
            const numDots = (y % 2 === 0) ? 9 : 10; const rowWidth = baseStepX * (numDots - 1); const centeringOffset = ((cvs.width - padX*2) - rowWidth) / 2;
            for(let x=0; x<numDots; x++) { ctx.beginPath(); ctx.arc(padX + centeringOffset + x * baseStepX, padY + y*stepY, radius, 0, Math.PI*2); ctx.fill(); }
        }
        const spkTex = new THREE.CanvasTexture(cvs);
        const spkPlane = new THREE.Mesh(new THREE.PlaneGeometry(1.0, 1.8), new THREE.MeshPhysicalMaterial({ map: spkTex, color: 0x000000, roughness: 1.0, metalness: 0.0, clearcoat: 0.0, reflectivity: 0.0, transparent: true, alphaTest: 0.1 }));
        spkPlane.position.set(-0.21, 0, Z_SURFACE + 0.01); deviceGroup.add(spkPlane);

        const padGroup = new THREE.Group(); padGroup.position.set(1.55, 0, Z_SURFACE); 
        const hs = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(2.24, 1.74, 0.25), { depth: 0.05, bevelEnabled: false}), matBlack); hs.geometry.center(); hs.position.z = 0.02; padGroup.add(hs);
        const btnGeom = new THREE.ExtrudeGeometry(createRoundedRect(0.88, 0.66, 0.12), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 }); btnGeom.center();
        const gapX = (2.24 - 2 * 0.88) / 3; const gapY = (1.74 - 2 * 0.66) / 3; const X_OFFSET = (0.88 / 2) + (gapX / 2); const Y_OFFSET = (0.66 / 2) + (gapY / 2);
        const positions = [{ x: -X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'MUSIC_BUTTON' }, { x: X_OFFSET, y: Y_OFFSET, mat: matBlack, name: 'STORY_BUTTON' }, { x: -X_OFFSET, y: -Y_OFFSET, mat: matBlack, name: 'CITY_INFO_BUTTON' }, { x: X_OFFSET, y: -Y_OFFSET, mat: matSteel, name: 'RECORD_BUTTON' }];
        positions.forEach((p) => {
            const b = new THREE.Mesh(btnGeom, p.mat); b.position.set(p.x, p.y, 0.04); b.name = p.name; b.userData.originalMat = p.mat;
            if(p.name === 'RECORD_BUTTON') { const dot = new THREE.Mesh(new THREE.CircleGeometry(0.04, 16), matBlackDot); dot.position.set(0.3, -0.2, 0.041); b.add(dot); redDotLED = dot; }
            padGroup.add(b); clickableObjects.push(b);
        });
        deviceGroup.add(padGroup);
        
        const bottomButton = new THREE.Mesh(new THREE.ExtrudeGeometry(createRoundedRect(1.0, 0.2, 0.08), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 }), matBlack);
        bottomButton.geometry.center(); bottomButton.rotation.x = THREE.MathUtils.degToRad(-90); 
        bottomButton.position.set(1.5, -1.1, 0.3 - 0.1); bottomButton.name = 'RESTART_BUTTON'; bottomButton.userData.originalMat = matBlack;
        chassis.add(bottomButton); clickableObjects.push(bottomButton);

        const bottomAuxGeo = new THREE.ExtrudeGeometry(createRoundedRect(0.88, 0.3, 0.08), { depth: 0.02, bevelEnabled: true, bevelSize: 0.03, bevelThickness: 0.03 });
        bottomAuxGeo.center(); const botAuxBtn = new THREE.Mesh(bottomAuxGeo, matBlack); 
        botAuxBtn.rotation.x = THREE.MathUtils.degToRad(90); botAuxBtn.position.set(0, -1.15, 0); 
        botAuxBtn.name = 'BOTTOM_AUX_BUTTON'; botAuxBtn.userData.originalMat = matBlack;
        chassis.add(botAuxBtn); clickableObjects.push(botAuxBtn);

        scene.add(deviceGroup);

        function onPointerDown(event) {
            // FIX: Disable model interaction on Research page
            if (currentSection === 'research') return;

            if (currentSection === 'view360' && !event.target.closest('button') && !event.target.closest('a')) { 
                isDragging = true; previousMousePosition = { x: event.clientX, y: event.clientY }; 
                document.getElementById('view360').classList.add('cursor-grabbing'); 
                document.getElementById('view360').classList.remove('cursor-grab'); 
                document.body.classList.add('hide-ui');
            }

            AudioManager.startBackground();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);
            if (intersects.length > 0) {
                let ie = intersects[0].object;
                
                // FIX: Disable Restart Button on 360 page - Ensure this logic runs
                if (currentSection === 'view360' && ie.name === 'RESTART_BUTTON') return;

                const intersection = intersects[0]; const localPoint = intersection.point.clone(); 
                let activeMeshes = []; 

                if (ie.parent && ie.parent.name === 'VOLUME_DIAL_RIM') {
                    const rimGroup = ie.parent; const groupLocalPoint = intersection.point.clone();
                    rimGroup.worldToLocal(groupLocalPoint);
                    const relX = groupLocalPoint.x; const relY = groupLocalPoint.y;
                    let targetQuad = -1;
                    if (Math.abs(relX) > Math.abs(relY) * 0.7) { 
                        if (relX > 0) { AudioManager.playNextTrack(); targetQuad = 1; } else { AudioManager.playPrevTrack(); targetQuad = 3; }
                    } else { 
                        if (relY > 0) { AudioManager.volumeUp(); targetQuad = 2; } else { AudioManager.volumeDown(); targetQuad = 0; }
                    }
                    ie = ie.parent; activeMeshes = ie.children.filter(c => c.userData.quadrant === targetQuad);
                } else {
                    ie.worldToLocal(localPoint); activeMeshes = [ie];
                }

                if (ie.name === 'PLAY_PAUSE_BUTTON') toggleAudioPlayback();
                else if (ie.name === 'MUSIC_BUTTON') AudioManager.play('music');
                else if (ie.name === 'STORY_BUTTON') AudioManager.play('story');
                else if (ie.name === 'CITY_INFO_BUTTON') AudioManager.play('info');
                else if (ie.name === 'RECORD_BUTTON') AudioManager.toggleRecord(() => { redDotLED.material = matRedLED; showMessage("Recording...", 50000); }, () => { redDotLED.material = matBlackDot; });
                else if (ie.name === 'RESTART_BUTTON') { AudioManager.stopAll(); showMessage("System Resetted.", 2000); }
                else if (ie.name === 'BOTTOM_AUX_BUTTON') showMessage("Service Port Accessed.", 2000);

                const oz = ie.position.z; const oy = ie.position.y; const os = ie.scale.clone();
                let momMat = matGrayPress;
                
                if (ie.name === 'VOLUME_DIAL_RIM') { activeMeshes.forEach(c => c.material = momMat); }
                if (['MUSIC_BUTTON', 'STORY_BUTTON', 'CITY_INFO_BUTTON', 'RECORD_BUTTON', 'BOTTOM_AUX_BUTTON'].includes(ie.name)) ie.material = momMat;
                if (ie.name === 'RESTART_BUTTON' || ie.name === 'BOTTOM_AUX_BUTTON') ie.position.y += 0.01; else ie.position.z -= 0.01; ie.scale.set(0.98, 0.98, 0.98);
                
                setTimeout(() => {
                    if (ie.name === 'RESTART_BUTTON' || ie.name === 'BOTTOM_AUX_BUTTON') ie.position.y = oy; else ie.position.z = oz; ie.scale.copy(os);
                    if (ie.name === 'VOLUME_DIAL_RIM') { activeMeshes.forEach(c => c.material = matBlack); } else if (ie.name !== 'PLAY_PAUSE_BUTTON') { ie.material = ie.userData.originalMat || matBlack; }
                }, 150);
            }
        }
        function onPointerMove(event) {
            if (isDragging && currentSection === 'view360') {
                const deltaMove = { x: event.clientX - previousMousePosition.x, y: event.clientY - previousMousePosition.y };
                manualRotation.y += deltaMove.x * 0.01; manualRotation.x += deltaMove.y * 0.01;
                previousMousePosition = { x: event.clientX, y: event.clientY };
            }
        }
        function onPointerUp() { 
            if (isDragging) { 
                isDragging = false; 
                document.getElementById('view360').classList.remove('cursor-grabbing'); 
                document.getElementById('view360').classList.add('cursor-grab'); 
                document.body.classList.remove('hide-ui');
                manualRotation = { x: 0, y: 0 };
            } 
        }

        const interactionTarget = document.getElementById('main-scroll-container');
        interactionTarget.addEventListener('pointerdown', onPointerDown, false);
        interactionTarget.addEventListener('pointermove', onPointerMove, false);
        interactionTarget.addEventListener('pointerup', onPointerUp, false);
        interactionTarget.addEventListener('pointerleave', onPointerUp, false);

        const targets = {
            'front': { cam: {x:0, y:-0.8, z:8.5}, rot: {x:0, y:0, z:0} },
            'functional': { cam: {x:0.5, y:0, z:5}, rot: {x:0, y:0.25, z:0} },
            'universal': { cam: {x:-0.5, y:0, z:5}, rot: {x:0, y:-0.25, z:0} },
            'specs': { cam: {x:0, y:0.8, z:7}, rot: {x:THREE.MathUtils.degToRad(-90), y:0, z:0} },
            'view360': { cam: {x:0, y:0, z:7}, rot: null },
            'research': { cam: {x:0, y:0, z:12}, rot: {x:0, y:0, z:0} }, 
            'prototype': { cam: {x:0, y:0, z:12}, rot: {x:0, y:0, z:0} } 
        };
        let currentSection = 'front';
        let previousSection = null; 

        function updateScroll() {
            const sections = ['front', 'functional', 'universal', 'specs', 'view360', 'research', 'prototype'];
            let bestMatch = sections[0]; let maxVis = 0;
            const scrollContainer = document.getElementById('main-scroll-container');
            const scrollTop = scrollContainer.scrollTop;
            const docHeight = scrollContainer.scrollHeight - scrollContainer.clientHeight;
            const scrollPercent = (scrollTop / docHeight) * 100;
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = scrollPercent + '%';

            sections.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const rect = el.getBoundingClientRect();
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
                if (visibleHeight > maxVis) { maxVis = visibleHeight; bestMatch = id; }
            });
            currentSection = bestMatch;
            
            if (currentSection !== previousSection) {
                const navContainer = document.querySelector('.nav-island .overflow-x-auto');
                document.querySelectorAll('.nav-item').forEach(item => {
                    const target = item.getAttribute('data-target');
                    if (target === currentSection) {
                        item.classList.add('active'); item.classList.remove('text-secondary'); 
                        if (navContainer) {
                            const itemRect = item.getBoundingClientRect();
                            const containerRect = navContainer.getBoundingClientRect();
                            const scrollLeft = navContainer.scrollLeft + (itemRect.left - containerRect.left) - (containerRect.width / 2) + (itemRect.width / 2);
                            navContainer.scrollTo({ left: scrollLeft, behavior: 'smooth' });
                        }
                    } else { item.classList.remove('active'); item.classList.add('text-secondary'); }
                });
                previousSection = currentSection;
            }
            
            const overlay = document.getElementById('universal-overlay');
            if(overlay) {
                const isUniversalVisible = document.getElementById('universal').classList.contains('is-visible');
                overlay.style.opacity = isUniversalVisible ? 1 : 0; 
                overlay.style.pointerEvents = isUniversalVisible ? 'auto' : 'none';
            }

            const maintenanceOverlay = document.getElementById('maintenance-overlay');
            if(maintenanceOverlay) {
                const showMaint = (currentSection === 'specs'); 
                maintenanceOverlay.style.opacity = showMaint ? 1 : 0; 
                maintenanceOverlay.style.pointerEvents = showMaint ? 'auto' : 'none';
            }
        }
        
        document.getElementById('main-scroll-container').addEventListener('scroll', updateScroll);

        function animate() {
            requestAnimationFrame(animate);
            const tgt = targets[currentSection];
            if(tgt) {
                camera.position.x += (tgt.cam.x - camera.position.x) * 0.05;
                camera.position.y += (tgt.cam.y - camera.position.y) * 0.05;
                camera.position.z += (tgt.cam.z - camera.position.z) * 0.05;

                if (currentSection === 'view360') {
                    const lerpFactor = isDragging ? 0.2 : 0.05; 
                    deviceGroup.rotation.x += (manualRotation.x - deviceGroup.rotation.x) * lerpFactor;
                    deviceGroup.rotation.y += (manualRotation.y - deviceGroup.rotation.y) * lerpFactor;
                    deviceGroup.rotation.z += (0 - deviceGroup.rotation.z) * lerpFactor;
                } else {
                    deviceGroup.rotation.x += (tgt.rot.x - deviceGroup.rotation.x) * 0.05;
                    deviceGroup.rotation.y += (tgt.rot.y - deviceGroup.rotation.y) * 0.05;
                    deviceGroup.rotation.z += (tgt.rot.z - deviceGroup.rotation.z) * 0.05;
                    manualRotation.x = 0; manualRotation.y = 0;
                }
            }
            deviceGroup.position.y = Math.sin(Date.now() * 0.001) * 0.05;

            if (currentSection === 'universal') {
                const time = Date.now() * 0.003; 
                const intensity = ((Math.sin(time) + 1) / 2) * 3.0;
                matSafetyGreen.emissiveIntensity = intensity;
            } else {
                matSafetyGreen.emissiveIntensity += (0.2 - matSafetyGreen.emissiveIntensity) * 0.1;
            }
            if (composer) composer.render(); else renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (composer) composer.setSize(window.innerWidth, window.innerHeight);
        });

        const initialOverlay = document.getElementById('audio-start-overlay');
        if (initialOverlay) initialOverlay.addEventListener('click', () => {
            AudioManager.startBackground();
            triggerPixelTransition();
        }, { once: true });

        window.onload = () => {
            const loader = document.getElementById('loader');
            if (loader) { loader.style.opacity = 0; setTimeout(() => { loader.style.display = 'none'; }, 500); }
            playPauseIcon = document.getElementById('play-pause-icon');
            updatePlayPauseIcon(true); 
            updateScroll();
            animate();
        };

        document.getElementById('btn-restart-overlay')?.addEventListener('click', () => { AudioManager.stopAll(); showMessage("System Resetted.", 2000); });
        document.getElementById('btn-play-pause-overlay')?.addEventListener('click', toggleAudioPlayback);
        document.getElementById('btn-prev')?.addEventListener('click', () => AudioManager.playPrevTrack());
        document.getElementById('btn-next')?.addEventListener('click', () => AudioManager.playNextTrack());
        document.getElementById('btn-vol-up')?.addEventListener('click', () => AudioManager.volumeUp());
        document.getElementById('btn-vol-down')?.addEventListener('click', () => AudioManager.volumeDown());
    })();
    </script>
</body>
</html>
